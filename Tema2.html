<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<title>Derecho Administrativo</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
:root{
  --text:#111827;
  --muted:#6b7280;
  --bd:rgba(17,24,39,.12);
  --bg:#ffffff;
  --pillbg:#f3f4f6;
  --pillbd:#e5e7eb;

  --prioBg:#eff6ff;
  --prioBd:#60a5fa;

  --ideaBg:#f5f3ff;
  --ideaBd:#a78bfa;

  --quizBg:#fff7ed;
  --quizBd:#fb923c;

  --okBg:#ecfdf5;
  --okBd:#34d399;

  --badBg:#fef2f2;
  --badBd:#f87171;

  --btnBg:#111827;
  --btnTxt:#ffffff;
  --btnBg2:#0b1220;
}

body{
  margin:0;
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
  background:var(--bg);
  color:var(--text);
}
.wrap{ max-width:1000px; margin:30px auto; padding:0 16px 60px }
h1{ margin:0 0 10px }
.small{ font-size:12px; opacity:.8; color:var(--muted) }

details{
  border:1px solid var(--bd);
  border-radius:14px;
  margin-bottom:12px;
  overflow:hidden;
}
summary{
  cursor:pointer;
  padding:14px 16px;
  font-weight:800;
  list-style:none;
  display:flex;
  gap:10px;
  align-items:flex-start;
  justify-content:flex-start;   /* üîß no space-between */
}
.sumLeft{
  display:flex;
  gap:10px;
  align-items:flex-start;
  min-width:0;
  flex:1 1 auto;                /* üîß ocupa el ancho */
}
.sumTitle{
  min-width:0;
  white-space:normal;           /* üîß permite saltos */
  overflow:visible;             /* üîß no recorta */
  text-overflow:clip;           /* üîß no pone ‚Ä¶ */
  word-break:break-word;
  line-height:1.25;
}

.pill{
  font-size:12px;
  padding:3px 8px;
  border-radius:999px;
  background:var(--pillbg);
  border:1px solid var(--pillbd);
  font-weight:800;
  white-space:nowrap;
}

.tag{
  font-size:11px;
  text-transform:uppercase;
  font-weight:800;
  letter-spacing:.1em;
  margin-bottom:6px;
}

.prio{
  background:var(--prioBg);
  border-left:5px solid var(--prioBd);
  padding:14px;
  border-radius:12px;
  margin-top:14px;
}
.idea{
  background:var(--ideaBg);
  border-left:5px solid var(--ideaBd);
  padding:14px;
  border-radius:12px;
  margin-top:14px;
  font-weight:650;
}
.quizBox{
  background:var(--quizBg);
  border-left:5px solid var(--quizBd);
  padding:14px;
  border-radius:12px;
  margin-top:14px;
}

.rowActions{
  display:flex;
  gap:10px;
  align-items:center;
  flex-wrap:wrap;
  margin-top:12px;
}

.btn{
  appearance:none;
  border:1px solid rgba(17,24,39,.15);
  background:transparent;
  padding:8px 10px;
  border-radius:10px;
  font-weight:800;
  cursor:pointer;
  color:var(--text);
}
.btn:hover{ background:rgba(17,24,39,.04) }

.btnPrimary{
  background:var(--btnBg);
  color:var(--btnTxt);
  border:1px solid rgba(17,24,39,.10);
}
.btnPrimary:hover{ background:var(--btnBg2) }

.badge{
  font-size:12px;
  font-weight:800;
  color:var(--muted);
}

p{ margin:0 0 10px; line-height:1.6; white-space:pre-wrap }

/* ===========================
   MODAL QUIZ
=========================== */
.modalOverlay{
  position:fixed;
  inset:0;
  background:rgba(17,24,39,.55);
  display:none;
  align-items:center;
  justify-content:center;
  padding:18px;
  z-index:9999;
}
.modalOverlay.show{ display:flex; }

.modal{
  width:min(860px, 100%);
  background:#fff;
  border-radius:16px;
  border:1px solid rgba(17,24,39,.12);
  box-shadow: 0 20px 60px rgba(0,0,0,.25);
  overflow:hidden;
}
.modalHeader{
  padding:14px 16px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  border-bottom:1px solid rgba(17,24,39,.10);
  background:linear-gradient(to bottom, rgba(17,24,39,.03), rgba(17,24,39,0));
}
.modalHeader .left{
  display:flex;
  gap:10px;
  align-items:center;
  min-width:0;
}
.modalHeader .title{
  font-weight:900;
  min-width:0;
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
}
.modalHeader .right{
  display:flex;
  gap:10px;
  align-items:center;
  flex-wrap:wrap;
}
.timerPill{
  font-size:12px;
  padding:3px 8px;
  border-radius:999px;
  border:1px solid rgba(17,24,39,.12);
  background:rgba(17,24,39,.04);
  font-weight:900;
}

.modalBody{ padding:16px; }
.qText{
  font-weight:900;
  font-size:16px;
  margin-bottom:12px;
}
.opts{
  display:flex;
  flex-direction:column;
  gap:10px;
}
.optBtn{
  text-align:left;
  border:1px solid rgba(17,24,39,.12);
  background:#fff;
  border-radius:12px;
  padding:12px 12px;
  cursor:pointer;
  font-weight:750;
}
.optBtn:hover{ background:rgba(17,24,39,.03) }
.optBtn .k{
  display:inline-flex;
  width:26px;
  height:26px;
  border-radius:999px;
  align-items:center;
  justify-content:center;
  margin-right:10px;
  border:1px solid rgba(17,24,39,.10);
  background:rgba(17,24,39,.04);
  font-weight:900;
}
.feedback{
  margin-top:14px;
  padding:12px;
  border-radius:12px;
  border-left:5px solid transparent;
  display:none;
}
.feedback.show{ display:block; }
.feedback.ok{ background:var(--okBg); border-left-color:var(--okBd); }
.feedback.bad{ background:var(--badBg); border-left-color:var(--badBd); }

.explicacion{
  margin-top:8px;
  font-size:13px;
  opacity:.9;
}

.modalFooter{
  padding:14px 16px;
  display:flex;
  gap:10px;
  align-items:center;
  justify-content:space-between;
  border-top:1px solid rgba(17,24,39,.10);
  flex-wrap:wrap;
}
.modalFooter .left{
  display:flex;
  gap:10px;
  align-items:center;
  flex-wrap:wrap;
}
kbd{
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
  font-size:12px;
  padding:2px 6px;
  border-radius:8px;
  border:1px solid rgba(17,24,39,.15);
  background:rgba(17,24,39,.04);
}
.scoreLine{
  font-size:12px;
  color:var(--muted);
  font-weight:800;
}

/* Caja de error visible */
.errBox{
  display:none;
  margin-top:12px;
  padding:12px;
  border-radius:12px;
  background:#fef2f2;
  border-left:5px solid #f87171;
  color:#111827;
  font-weight:800;
}
.errBox.show{ display:block; }

/* Diagn√≥stico */
.diag{
  margin-top:12px;
  padding:12px;
  border:1px solid rgba(17,24,39,.12);
  border-radius:12px;
  background:rgba(17,24,39,.02);
  font-size:12px;
  color:var(--muted);
  font-weight:800;
  display:flex;
  gap:10px;
  flex-wrap:wrap;
}
.diag b{ color:#111827; }
</style>
</head>

<body>
<div class="wrap">
  <h1 id="tituloTema">CAP√çTULO 2 - EL MATRIMONIO</h1>
  <div class="small"> by M.Garc√≠a</div>

  <div id="errBox" class="errBox"></div>
  <div id="diag" class="diag">Diagn√≥stico: <b>cargando‚Ä¶</b></div>

  <div class="rowActions" style="margin-top:12px">
    <button class="btn btnPrimary" id="btnTemaRandom" type="button">Realiza test por tema</button>

    <label class="badge" style="display:flex; gap:8px; align-items:center;">
      N¬∫ preguntas
      <select id="selTemaN" class="btn" style="padding:6px 10px;">
        <option value="10">10</option>
        <option value="20" selected>20</option>
        <option value="50">50</option>
        <option value="100">100</option>
      </select>
    </label>

    <button class="btn" id="btnSoloFalladas" type="button">Solo falladas</button>
    <button class="btn" id="btnResetStats" type="button">Reiniciar stats</button>
    <span class="badge" id="badgeTemaTotal">0 preguntas cargadas</span>
  </div>

  <div id="contenido" style="margin-top:14px"></div>
</div>

<!-- MODAL -->
<div id="modalOverlay" class="modalOverlay" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="modal">
    <div class="modalHeader">
      <div class="left">
        <span id="modalPill" class="pill">‚Äî</span>
        <div class="title" id="modalTitle">Pregunta</div>
      </div>
      <div class="right">
        <span class="timerPill" id="modalTimer">00:00</span>
        <button class="btn" id="btnCloseModal" type="button">Cerrar</button>
      </div>
    </div>

    <div class="modalBody">
      <div class="qText" id="modalQuestion">‚Äî</div>
      <div class="opts" id="modalOptions"></div>

      <div id="modalFeedback" class="feedback">
        <div id="modalFeedbackTitle" style="font-weight:900"></div>
        <div class="explicacion" id="modalExplanation"></div>
      </div>
    </div>

    <div class="modalFooter">
      <div class="left">
        <button class="btn btnPrimary" id="btnNextQuestion" type="button">Siguiente</button>
        <button class="btn" id="btnBlank" type="button">Dejar en blanco</button>
        <span class="badge" id="modalCounter">0/0</span>
      </div>
      <div>
        <div class="scoreLine" id="scoreLine">Aciertos 0 ¬∑ Fallos 0 ¬∑ Blancos 0 ¬∑ Puntos 0.00 (de 0)</div>
        <div class="small">Atajos: <kbd>Esc</kbd> cerrar ¬∑ <kbd>Enter</kbd> siguiente</div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const errBox = document.getElementById("errBox");
  const diag = document.getElementById("diag");

  function showErr(msg){
    if(!errBox) return;
    errBox.textContent = msg;
    errBox.classList.add("show");
  }

  window.addEventListener("error", (e)=>{
    showErr("Error JS: " + (e.message || "desconocido"));
  });

  try{
    /* =========================
       ‚úÖ PUNTUACI√ìN (UNA SOLA VEZ)
    ========================= */
    const SCORE_OK = 0.5;
    const SCORE_BAD = 0.20;   // resta
    const SCORE_BLANK = 0;    // no suma ni resta

    /* =========================================================
       1) TEXTO BASE (tu PDF pegado)
    ========================================================= */
    const PDF_TEXTO = `
1. EL MATRIMONIO
Hasta la aprobaci√≥n de la Ley 13/2005, de 1 de julio, el matrimonio ha sido concebido en
nuestra sociedad como la uni√≥n estable entre hombre y mujer destinada a compartir la vida y
sus avatares. En lo esencial, la idea contempor√°nea de matrimonio mantiene una notable
continuidad con concepciones hist√≥ricas anteriores.
Desde la perspectiva civil, el an√°lisis del matrimonio prescinde de los aspectos religiosos o
sacramentales, propios de la tradici√≥n romana y, especialmente, de la can√≥nica, aunque debe
reconocerse que el desarrollo del Derecho can√≥nico ha influido de forma relevante en
numerosos aspectos de la regulaci√≥n jur√≠dico-civil del matrimonio. En este ep√≠grafe
introductorio se atiende al matrimonio desde una √≥ptica laica y estatal, destacando sus notas
culturales y jur√≠dicas fundamentales, sin establecer jerarqu√≠as ni menosprecio respecto de
otras formas de convivencia.
1.1. Heterosexualidad y LGTBI
Hasta la aprobaci√≥n de la Ley 13/2005, el matrimonio exig√≠a la uni√≥n de un hombre y una
mujer, quedando excluidas otras relaciones de pareja no compuestas por personas de distinto
sexo, con independencia de que se tratara de parejas homosexuales masculinas o femeninas o
de personas transexuales. Esta concepci√≥n tradicional fue considerada confirmada
impl√≠citamente por el art. 32 de la Constituci√≥n, al reconocer que el hombre y la mujer tienen
derecho a contraer matrimonio.
Una parte minoritaria de la doctrina defendi√≥ la posibilidad del matrimonio de personas
transexuales tras el reconocimiento judicial del cambio de sexo, posici√≥n respaldada por la
Resoluci√≥n de la Direcci√≥n General de los Registros y del Notariado de 24 de enero de
2005, aunque con argumentos discutidos. Posteriormente, la Ley 3/2007, sobre rectificaci√≥n
registral del sexo, introdujo nuevos criterios que han sido superados por la Ley 4/2023, para la
igualdad real y efectiva de las personas trans y la garant√≠a de los derechos de las personas
LGTBI.
La Ley 4/2023 reconoce la autodeterminaci√≥n de g√©nero, refuerza la igualdad real y efectiva
de las personas LGTBI y establece mecanismos de protecci√≥n frente a la discriminaci√≥n. Su
disposici√≥n adicional segunda modifica el art. 44 del C√≥digo Civil, proclamando que toda
persona tiene derecho a contraer matrimonio conforme al C√≥digo Civil, quedando derogada la
Ley 3/2007 y siendo aplicable el nuevo r√©gimen de rectificaci√≥n registral del sexo.
1.2. Monogamia
En la cultura occidental, el matrimonio ha implicado tradicionalmente la uni√≥n de un solo
hombre con una sola mujer. Tras la admisi√≥n del matrimonio homosexual, el requisito de la
monogamia se mantiene, de modo que el matrimonio debe celebrarse entre dos personas, y
solo dos, con independencia de su sexo.
En el √°mbito cultural y jur√≠dico vigente, contin√∫a afirm√°ndose la exigencia de la monogamia, sin
que otras f√≥rmulas de colectivizaci√≥n de las relaciones afectivas tengan encaje en el Derecho
positivo. No obstante, algunos autores contrarios al matrimonio homosexual sostienen que,
eliminada la heterosexualidad como requisito y atendiendo a criterios sociol√≥gicos, podr√≠a
plantearse en el futuro la superaci√≥n de la monogamia, siguiendo modelos culturales distintos,
como los que admiten la pluralidad de esposas, lo que obligar√≠a a considerar tambi√©n supuestos
de poliandria.
1.3. Comunidad de vida y existencia
La celebraci√≥n del matrimonio est√° orientada a constituir una relaci√≥n √≠ntima y estable que
comprende los aspectos esenciales de la vida, afrontados en com√∫n por los c√≥nyuges, sin que
ninguno de ellos pierda su propia individualidad. Aunque esta nota resulte dif√≠cil de delimitar en
sentido positivo, adquiere especial relevancia por sus consecuencias negativas.
El matrimonio no puede concebirse como una relaci√≥n destinada a satisfacer necesidades
afectivas o carnales pasajeras, ni como una uni√≥n moment√°nea o circunstancial, carente de
la voluntad de formar una aut√©ntica comunidad de vida y existencia. Tampoco responden a esta
idea los matrimonios celebrados con la finalidad de obtener ventajas ajenas a la convivencia,
como ocurre con los denominados matrimonios de complacencia, que no obedecen al
prop√≥sito de constituir una verdadera comunidad de vida.
1.4. Estabilidad
La estabilidad o permanencia es una nota inherente a la uni√≥n matrimonial y se presenta como
corolario de la comunidad de vida y existencia. En algunos sistemas normativos, esta estabilidad
se concibe como perpetuidad vitalicia, al asentarse el matrimonio en el principio de
indisolubilidad. No obstante, esta concepci√≥n no corresponde a la legislaci√≥n espa√±ola
contempor√°nea, tras la promulgaci√≥n de la Ley 30/1981.
1.5. Solemnidad: Referencia a las uniones de hecho
El consentimiento matrimonial es un acto solemne, revestido de formalidades legales que
garantizan la concurrencia de los presupuestos exigidos por el ordenamiento. Cuando no se
cumplen tales requisitos formales, aun existiendo convivencia y los restantes elementos del
matrimonio, la relaci√≥n debe calificarse como uni√≥n de hecho, denominada tambi√©n uni√≥n libre,
concubinato, convivencia more uxorio o pareja de hecho.
Existe un movimiento social favorable a las parejas de hecho, y diversas normas y resoluciones
judiciales han asimilado en aspectos concretos estas uniones al matrimonio. No obstante, no
existe una regulaci√≥n estatal general, aunque varias Comunidades Aut√≥nomas han aprobado
leyes propias y, en todo caso, existe un Registro de Parejas de Hecho para acreditar su
existencia y duraci√≥n a efectos concretos.
En algunas regulaciones auton√≥micas se exige la inscripci√≥n registral para acceder a
determinados efectos legales, estableci√©ndose requisitos espec√≠ficos. Los principales problemas
jur√≠dicos surgen en el momento de la ruptura, pues, en general, no procede la aplicaci√≥n
anal√≥gica del r√©gimen matrimonial, debiendo acudirse a la normativa existente, a los pactos entre
las partes o, en su defecto, a criterios como el enriquecimiento injusto u otras construcciones
jurisprudenciales. Las obligaciones respecto de los hijos no se ven afectadas por la existencia
o no de matrimonio o pareja de hecho.
2. EL MATRIMONIO HOMOSEXUAL O ENTRE PERSONAS DEL MISMO SEXO
La Ley 13/2005 supuso una ruptura hist√≥rica con la concepci√≥n secular del matrimonio,
tradicionalmente presidida por la heterosexualidad y vinculada indirectamente a la reproducci√≥n.
Desde una perspectiva hist√≥rica, la reforma introdujo una idea inicialmente revolucionaria,
aunque comparable a otras transformaciones jur√≠dicas que con el tiempo se han consolidado
como principios generalmente aceptados, como la igualdad entre hombre y mujer o la abolici√≥n
de la esclavitud.
La incidencia real del matrimonio homosexual en Espa√±a es estad√≠sticamente reducida, pues no
alcanza ni el uno por ciento del total de n√∫cleos familiares, lo que pone de relieve la distancia
entre la percepci√≥n social generada por la norma y la realidad demogr√°fica.
En el Derecho comparado, numerosos pa√≠ses reconocen el matrimonio entre personas del mismo
sexo o figuras equivalentes, mientras que en otros Estados la homosexualidad contin√∫a siendo
delito. En Estados Unidos, tras diversas regulaciones estatales, la sentencia del Tribunal
Supremo de 26 de junio de 2015 declar√≥ inconstitucionales las prohibiciones del matrimonio
homosexual, imponiendo su validez en todos los Estados.
En el √°mbito internacional privado, la Resoluci√≥n de la DGRN de 7 de abril de 2006 reconoci√≥ la
validez en Espa√±a del matrimonio entre un espa√±ol y un extranjero cuya ley nacional no admit√≠a
este tipo de matrimonio. Asimismo, la sentencia del TJUE de 5 de junio de 2018 (asunto
Coman) interpret√≥ el concepto de ‚Äúc√≥nyuge‚Äù de forma neutra desde el punto de vista del g√©nero
a efectos de residencia, obligando a los Estados miembros a reconocer el matrimonio
homosexual para tales fines, sin imponerles su regulaci√≥n interna.
3. LA NATURALEZA DEL MATRIMONIO
Aunque la noci√≥n social de matrimonio ha sido clara durante siglos, los juristas han debatido
hist√≥ricamente sobre su calificaci√≥n t√©cnica, con independencia de la admisi√≥n del divorcio o
del matrimonio homosexual. El problema no es definir qu√© es el matrimonio en t√©rminos sociales,
sino c√≥mo debe ser calificado jur√≠dicamente.
3.1. La tesis contractual
Desde la recepci√≥n medieval del Derecho can√≥nico, al incorporarse la aÔ¨Äectio maritalis romana
como elemento consensual, se sostuvo la consideraci√≥n del matrimonio como contrato, tesis
especialmente atractiva para los canonistas, al permitir justificar el v√≠nculo y la indisolubilidad
mediante el principio pacta sunt servanda.
Sin embargo, esta concepci√≥n presenta graves dificultades, ya que los contratos civiles se basan
en la autonom√≠a privada, la libertad de estipulaci√≥n y la posibilidad de ineficacia del contrato
incumplido, elementos incompatibles con el esquema matrimonial, especialmente cuando rige el
principio de indisolubilidad.
Para salvar estas objeciones, algunos autores calificaron el matrimonio como contrato sui
generis, entendiendo que carece de las notas esenciales de los contratos, dado que su
contenido y efectos est√°n normativamente predeterminados. No obstante, esta soluci√≥n resulta
insatisfactoria, pues la relaci√≥n matrimonial carece de patrimonialidad t√©cnica, y la mera
coincidencia de consentimientos no permite aplicar el r√©gimen jur√≠dico propio de los contratos.
3.2. El matrimonio como ‚Äúnegocio jur√≠dico de Derecho de familia‚Äù
El desarrollo de la categor√≠a del negocio jur√≠dico llev√≥ a algunos autores a calificar el matrimonio
como un negocio jur√≠dico complejo y t√≠pico del Derecho de familia, entendiendo que esta
noci√≥n permit√≠a explicar su singularidad. Sin embargo, esta calificaci√≥n supone una mera
abstracci√≥n conceptual que no mejora la comprensi√≥n de la instituci√≥n.
La noci√≥n de negocio jur√≠dico aplicada al matrimonio no aclara su r√©gimen normativo, ni explica
sus efectos materiales, que se encuentran predeterminados por el Derecho positivo,
generando adem√°s indefinici√≥n y confusi√≥n conceptual.
3.3. La instituci√≥n matrimonial
Aunque el consentimiento es imprescindible, no es suficiente para determinar la existencia
del matrimonio, como demuestra la diferencia entre matrimonio y uniones de hecho. El
llamado estatuto matrimonial queda sustra√≠do a la voluntad de los contrayentes y es
imperativamente fijado por la ley, salvo en aspectos concretos como el r√©gimen
econ√≥mico.
Ello evidencia que el matrimonio constituye una instituci√≥n jur√≠dica propia y aut√≥noma, dotada
de un conjunto normativo espec√≠fico, que regula tanto su nacimiento como su desarrollo y
crisis. Esta concepci√≥n institucional ha sido reiteradamente respaldada por la jurisprudencia del
Tribunal Supremo y del Tribunal Constitucional, as√≠ como por el propio legislador en las
Exposiciones de Motivos de las Leyes 13/2005 y 15/2005.
4. LOS SISTEMAS MATRIMONIALES
4.1. La idea de ‚Äúsistema matrimonial‚Äù
La expresi√≥n sistema matrimonial se ha utilizado tradicionalmente por la doctrina civilista para
referirse a la ordenaci√≥n que realiza el Estado sobre las formas o ritos matrimoniales a los
que se reconoce eficacia y validez civil. Se trata, por tanto, del modo en que un ordenamiento
jur√≠dico decide qu√© matrimonios son v√°lidos desde el punto de vista civil y bajo qu√© formas
pueden celebrarse.
Autores cl√°sicos como S√°nchez Rom√°n y Lacruz Berdejo definieron los sistemas matrimoniales
como los criterios legales adoptados por los distintos Estados para reputar v√°lidamente
celebrado el matrimonio, especialmente en relaci√≥n con la forma de celebraci√≥n civilmente
eficaz.
El concepto tiene una funci√≥n sistem√°tica y comparada, pues permite identificar los elementos
normativos esenciales de cada ordenamiento en materia matrimonial y comparar las distintas
soluciones adoptadas por los Estados.
En Europa, y particularmente en Espa√±a, la cuesti√≥n se ve condicionada por la precedencia
hist√≥rica del matrimonio can√≥nico, cuya regulaci√≥n y jurisdicci√≥n por parte de la Iglesia
Cat√≥lica se adelant√≥ durante siglos a la configuraci√≥n del matrimonio civil por los Estados
modernos. De ah√≠ que el problema del sistema matrimonial est√© ligado a la relaci√≥n entre el
poder civil y las confesiones religiosas.
Aunque la noci√≥n de sistema matrimonial es, desde el punto de vista te√≥rico, una categor√≠a
expositiva, la decisi√≥n legislativa sobre el sistema adoptado constituye una opci√≥n pol√≠tica
de gran relevancia, pues implica determinar si el Estado asume en exclusiva la potestad
normativa y jurisdiccional sobre el matrimonio o si la comparte, en mayor o menor medida, con
las confesiones religiosas.
4.2. Clasificaci√≥n de los sistemas matrimoniales
La clasificaci√≥n de los sistemas matrimoniales tiene un valor instrumental y proped√©utico, y
debe limitarse a los criterios fundamentales, evitando casuismos excesivos.
A) Forma o formas matrimoniales
El primer criterio clasificatorio atiende a si el ordenamiento reconoce una sola forma de
matrimonio o varias formas con eficacia civil.
1) Sistemas de matrimonio √∫nico
Dentro de estos sistemas se distinguen dos opciones:
a) Matrimonio exclusivamente religioso
Caracter√≠stico de Estados confesionales o teocr√°ticos. Hist√≥ricamente fue el modelo vigente en
Espa√±a desde la Real C√©dula de 1562 hasta la Ley de Matrimonio Civil de 1870.
b) Reconocimiento exclusivo del matrimonio civil
El Estado solo reconoce efectos civiles al matrimonio celebrado conforme a sus propias normas,
dejando el matrimonio religioso como una cuesti√≥n de conciencia personal. Este modelo surge
con la Revoluci√≥n francesa y el Code Napol√©on y se extendi√≥ a numerosos pa√≠ses europeos,
rigiendo tambi√©n en Espa√±a durante un breve periodo.
2) Reconocimiento estatal de plurales formas de matrimonio
El Estado reconoce varias formas matrimoniales con eficacia civil. Dentro de estos sistemas cabe
distinguir:
‚Ä¢ Sistema de libertad de forma, en el que cualquier forma ser√≠a v√°lida sin
formalidades obligatorias, modelo que carece de relevancia pr√°ctica y doctrinal por
razones de seguridad jur√≠dica.
‚Ä¢ Sistemas electivos, en los que el Estado determina varias formas
matrimoniales v√°lidas y permite al ciudadano elegir entre ellas.
Dentro de los sistemas electivos se distinguen:
a) Sistema electivo formal
El Estado reconoce efectos civiles a los matrimonios religiosos, pero se reserva en
exclusiva la regulaci√≥n y jurisdicci√≥n matrimonial, incorporando las normas religiosas al
ordenamiento estatal (caso de Inglaterra).
b) Sistema electivo material
El Estado respeta las normas propias de la confesi√≥n religiosa en el matrimonio religioso
(forma, ritos, disoluci√≥n), otorg√°ndole efectos civiles, mientras regula la forma civil del
matrimonio. Puede existir o no reserva de jurisdicci√≥n estatal, sin que ello altere la
naturaleza del sistema.
B) Igualdad o subsidiariedad
El segundo criterio atiende a si las distintas formas matrimoniales se reconocen en plano de
igualdad o en relaci√≥n de subordinaci√≥n.
1) Sistemas facultativos
Las distintas formas matrimoniales se reconocen en plano de igualdad, sin primac√≠a del
matrimonio civil ni del religioso. El ciudadano puede optar libremente por cualquiera. Tambi√©n se
denominan sistemas puramente electivos.
2) Sistemas de subsidiariedad
Se otorga primac√≠a a una forma matrimonial, siendo las dem√°s subsidiarias. Est√°n vinculados a
la confesionalidad estatal y suelen permitir una forma alternativa solo a quienes acrediten no
profesar la confesi√≥n dominante.
5. LA CONSTITUCI√ìN DE 1978 Y EL SISTEMA MATRIMONIAL
La Constituci√≥n de 1978 impuso un replanteamiento completo del sistema matrimonial, al
consagrar los principios de aconfesionalidad del Estado (art. 16.3 CE), libertad religiosa y de
creencias (art. 16 CE) y la recuperaci√≥n del poder civil en materia matrimonial (art. 32.2 CE).
Estos principios resultan incompatibles con el sistema de matrimonio civil subsidiario, propio
de Estados confesionales.
La primera manifestaci√≥n de este nuevo marco constitucional fue la sustituci√≥n del Concordato
de 1953 por el Acuerdo entre el Estado espa√±ol y la Santa Sede de 3 de enero de 1979, que
mantiene el reconocimiento de efectos civiles al matrimonio can√≥nico, pero sin sometimiento del
Derecho estatal a la normativa can√≥nica, en coherencia con el principio de cooperaci√≥n religiosa
previsto en la Constituci√≥n.
Posteriormente, las Leyes 24/1992, 25/1992 y 26/1992 aprobaron los Acuerdos de Cooperaci√≥n
con las confesiones evang√©lica, jud√≠a e isl√°mica, reconociendo efectos civiles a los matrimonios
celebrados conforme a sus ritos, siempre que se inscriban en el Registro Civil. Estas
normasfueron modificadas por la Ley 15/2015, que ampli√≥ los √≥rganos competentes para
tramitar el expediente previo matrimonial.
La reforma decisiva del sistema matrimonial vino dada por las Leyes 11/1981 y 30/1981, que
transformaron el Derecho de familia del C√≥digo Civil conforme a los principios constitucionales. El
sistema resultante es un sistema electivo formal y facultativo, definido como un sistema de
forma m√∫ltiple y clase √∫nica (civil), en el que el Estado reconoce efectos civiles a matrimonios
celebrados en distintas formas religiosas, pero se reserva la regulaci√≥n jur√≠dica del matrimonio.
Este car√°cter electivo formal se ve reforzado por la reforma del art. 60.2 CC, que ampl√≠a el
reconocimiento de efectos civiles a matrimonios celebrados conforme a ritos de confesiones
religiosas con notorio arraigo en Espa√±a. En todo caso, el Estado mantiene la competencia
exclusiva para legislar sobre las formas de matrimonio (art. 149.1.8 CE), quedando excluida
cualquier intervenci√≥n normativa auton√≥mica en esta materia.
6. LOS ESPONSALES O PROMESA DE MATRIMONIO
6.1. Terminolog√≠a y concepto
En la redacci√≥n vigente del C√≥digo Civil, la figura tradicionalmente conocida como esponsales
recibe la denominaci√≥n exclusiva de promesa de matrimonio. Con uno u otro nombre, la
instituci√≥n consiste en la promesa rec√≠proca de contraer matrimonio realizada por los novios,
que eventualmente llegar√°n a ser c√≥nyuges si el matrimonio llega a celebrarse.
Los esponsales presentan una evoluci√≥n hist√≥rica caracterizada por un pasado de gran
relevancia jur√≠dica, un presente de escasa aplicaci√≥n pr√°ctica y un futuro incierto, en un
contexto social marcado por el abandono de rituales y formalismos. Su importancia hist√≥rica se
manifiesta en su regulaci√≥n en el Derecho romano, en el Derecho can√≥nico medieval y en las
disposiciones de la Iglesia Cat√≥lica, incluyendo el Codex iuris canonici. El Digesto los defin√≠a
como sponsalia sunt mentio et repromissio nuptiarum futurarum, y el propio t√©rmino procede del
verbo latino spondere.
Hasta la Ley 30/1981, el C√≥digo Civil utilizaba tambi√©n la denominaci√≥n esponsales, pero el
legislador opt√≥ por sustituirla por la expresi√≥n promesa de matrimonio, en un intento de
secularizaci√≥n nominal y de alejamiento del lenguaje can√≥nico. No obstante, desde el punto de
vista sem√°ntico y jur√≠dico, ambas expresiones designan la misma realidad, siendo la diferencia
meramente terminol√≥gica.
En la pr√°ctica actual, la promesa de matrimonio carece de la relevancia que tuvo hist√≥ricamente y
no es equiparable a la convivencia marital ni al matrimonio. As√≠ lo ha declarado la jurisprudencia,
negando que la mera promesa de matrimonio pueda considerarse uni√≥n de hecho o arraigo
familiar suficiente para producir determinados efectos jur√≠dicos, como la suspensi√≥n de una orden
de expulsi√≥n de extranjeros.
6.2. Libertad matrimonial y esponsales
Desde los precedentes del Derecho romano, la libertad matrimonial de los contrayentes se
mantiene intacta hasta el mismo momento de la celebraci√≥n del matrimonio, exista o no promesa
previa. Este principio se basa en la incoercibilidad del consentimiento matrimonial, que impide
obligar jur√≠dicamente a contraer matrimonio.
El vigente art. 42 del C√≥digo Civil establece que la promesa de matrimonio no produce
obligaci√≥n de contraerlo, ni de cumplir lo pactado para el supuesto de su no celebraci√≥n, y que
no se admitir√° demanda alguna que pretenda exigir su cumplimiento. Se prioriza as√≠ la libertad
matrimonial hasta el instante mismo de la prestaci√≥n del consentimiento.
El C√≥digo Civil mantiene la tradici√≥n hist√≥rica conforme a la cual la incoercibilidad del matrimonio
no puede eludirse mediante cl√°usulas penales u otras estipulaciones vinculadas a la promesa
dematrimonio. En consecuencia, los esponsales carecen de eficacia vinculante respecto de la
celebraci√≥n del matrimonio.
La promesa de matrimonio no tiene naturaleza contractual, ni puede calificarse como
precontrato ni como acuerdo jur√≠dico propiamente dicho. Se trata de un uso social reconocido
por la ley, cuya relevancia jur√≠dica se limita a la posible obligaci√≥n legal de resarcir los gastos
realizados en atenci√≥n al matrimonio proyectado, configur√°ndose dicha obligaci√≥n ex lege, a
partir de la existencia f√°ctica de la promesa.
6.3. La obligaci√≥n de resarcimiento de los gastos asumidos
El art. 43.1 del C√≥digo Civil establece que el incumplimiento sin causa de la promesa cierta
de matrimonio, realizada por persona mayor de edad o menor emancipado, solo produce la
obligaci√≥n de resarcir a la otra parte de los gastos hechos y de las obligaciones contra√≠das
en consideraci√≥n al matrimonio prometido. La consecuencia jur√≠dica de la no celebraci√≥n del
matrimonio se limita, por tanto, al resarcimiento del perjuicio patrimonial sufrido por quien
confi√≥ en la promesa.
El fundamento del resarcimiento radica en la quiebra de la confianza leg√≠tima generada por la
promesa de matrimonio, evitando un empobrecimiento patrimonial carente de sentido al
frustrarse el matrimonio proyectado. El resarcimiento comprende tanto los gastos efectivamente
realizados como las obligaciones asumidas, aunque no se hayan hecho a√∫n efectivas, siempre
que est√©n directamente vinculadas al matrimonio previsto y sean debidamente probadas.
La responsabilidad derivada del art. 43 CC tiene un alcance limitado, circunscrito a las partidas
expresamente previstas en el precepto. Cuando se producen da√±os patrimoniales distintos o
superiores, la v√≠a adecuada ser√° la acci√≥n por enriquecimiento sin causa, quedando excluida la
aplicaci√≥n del art. 1902 CC.
El precepto exige que el incumplimiento sea ‚Äúsin causa‚Äù, a diferencia de la redacci√≥n anterior,
que exig√≠a ‚Äújusta causa‚Äù. La supresi√≥n del adjetivo implica que basta con que quien no desea
contraer matrimonio alegue una causa suficiente para s√≠ mismo, derivada del ejercicio de su
libertad matrimonial, lo que act√∫a como circunstancia exoneradora del resarcimiento. De este
modo, la exigencia legal de causa queda notablemente atenuada.
El art. 43.2 CC dispone que la acci√≥n de resarcimiento caduca al a√±o, contado desde el d√≠a de
la negativa a la celebraci√≥n del matrimonio. Se trata, en t√©rminos literales, de un plazo de
caducidad, no susceptible de interrupci√≥n, aunque la cuesti√≥n carece pr√°cticamente de
relevancia pr√°ctica por la escasa litigiosidad en esta materia.
`.trim();

    /* =========================================================
       2) IDEAS CLAVE (MANUAL)
    ========================================================= */
    const IDEAS_CLAVE = {

  "1": "El matrimonio es una instituci√≥n jur√≠dica civil que regula una uni√≥n estable de vida en com√∫n, con continuidad hist√≥rica y desvinculada en su an√°lisis jur√≠dico de los elementos religiosos.",
  "1.1": "La evoluci√≥n normativa ha eliminado la heterosexualidad como requisito matrimonial, reconociendo el derecho universal a contraer matrimonio y reforzando la igualdad y la autodeterminaci√≥n de g√©nero.",
  "1.2": "La monogamia sigue siendo un requisito estructural del matrimonio, configur√°ndolo como uni√≥n exclusiva entre dos personas con independencia de su sexo.",
  "1.3": "El matrimonio exige la voluntad de constituir una aut√©ntica comunidad estable de vida y existencia, excluyendo uniones instrumentales o de conveniencia.",
  "1.4": "La estabilidad es un rasgo esencial del matrimonio, aunque en el sistema espa√±ol actual no implica indisolubilidad permanente.",
  "1.5": "El matrimonio es un acto solemne sujeto a formalidades legales, diferenci√°ndose de las uniones de hecho, que carecen de regulaci√≥n estatal general y generan efectos jur√≠dicos limitados.",

  "2": "El matrimonio entre personas del mismo sexo supuso una transformaci√≥n hist√≥rica del concepto jur√≠dico matrimonial basada en igualdad y no discriminaci√≥n, con reconocimiento progresivo en el Derecho comparado.",

  "3": "La discusi√≥n jur√≠dica sobre la naturaleza del matrimonio se centra en su calificaci√≥n t√©cnica m√°s que en su definici√≥n social.",
  "3.1": "La tesis contractual del matrimonio es insuficiente porque la instituci√≥n matrimonial carece de autonom√≠a negocial plena y de contenido patrimonial t√≠pico.",
  "3.2": "La calificaci√≥n del matrimonio como negocio jur√≠dico es una construcci√≥n doctrinal abstracta que no explica adecuadamente su r√©gimen jur√≠dico real.",
  "3.3": "El matrimonio es una instituci√≥n jur√≠dica aut√≥noma cuyo contenido esencial viene determinado imperativamente por la ley, m√°s all√° del consentimiento inicial.",

  "4": "El sistema matrimonial define qu√© formas de matrimonio reconoce el Estado con eficacia civil y bajo qu√© condiciones jur√≠dicas.",
  "4.1": "El sistema matrimonial es la opci√≥n estatal sobre las formas v√°lidas de celebraci√≥n matrimonial y refleja decisiones pol√≠ticas sobre la relaci√≥n entre Estado y religi√≥n.",
  "4.2": "Los sistemas matrimoniales se clasifican seg√∫n la pluralidad de formas admitidas y seg√∫n su reconocimiento en plano de igualdad o subordinaci√≥n.",

  "5": "La Constituci√≥n de 1978 configur√≥ un sistema matrimonial basado en aconfesionalidad, libertad religiosa y primac√≠a normativa del Estado en materia matrimonial.",

  "6": "Los esponsales o promesa de matrimonio son un uso social con relevancia jur√≠dica limitada, sin eficacia obligacional para contraer matrimonio.",
  "6.1": "La promesa de matrimonio es una promesa rec√≠proca socialmente reconocida sin naturaleza contractual ni efectos obligacionales para celebrar el matrimonio.",
  "6.2": "La libertad matrimonial implica que la promesa de matrimonio no puede obligar jur√≠dicamente a contraer matrimonio ni mediante pactos ni cl√°usulas penales.",
  "6.3": "El incumplimiento injustificado de la promesa matrimonial solo genera obligaci√≥n de resarcir gastos y compromisos asumidos en atenci√≥n al matrimonio proyectado."

    };

    /* =========================================================
       3) BANCO DE PREGUNTAS (TU BANCO ORIGINAL)
       ‚úÖ OJO: aqu√≠ pegamos TAL CUAL tu banco (1‚Äì100)
    ========================================================= */
    const BANCO_1 = `#ID=1


// [1]
Q: Desde el punto de vista civil, ¬øqu√© rasgo identifica mejor al matrimonio como instituci√≥n jur√≠dica?
A) Una convivencia socialmente relevante sin necesidad de forma legal.
B) Una comunidad de vida jur√≠dicamente constituida mediante consentimiento formalizado.
C) Un acuerdo privado orientado principalmente a producir efectos patrimoniales.
OK: B
EXP: En la √≥ptica civil, el matrimonio es una instituci√≥n jur√≠dica basada en consentimiento solemne que crea un estatuto legal de vida en com√∫n.

// [2]
Q: ¬øPor qu√© el Derecho civil analiza el matrimonio desde una perspectiva laica y estatal?
A) Porque la regulaci√≥n civil se centra en efectos jur√≠dicos y deja lo religioso fuera del estatuto civil.
B) Porque las confesiones religiosas no pueden celebrar matrimonios en ning√∫n caso.
C) Porque el matrimonio carece de relevancia hist√≥rica fuera del √°mbito civil.
OK: A
EXP: El an√°lisis civil prescinde de lo sacramental para centrarse en la instituci√≥n jur√≠dica estatal y sus efectos.

// [3]
Q: ¬øC√≥mo debe entenderse, en t√©rminos generales, la influencia del Derecho can√≥nico en el matrimonio civil?
A) Como una sustituci√≥n completa del modelo civil por el religioso en la legislaci√≥n vigente.
B) Como una influencia hist√≥rica relevante en m√∫ltiples aspectos de la regulaci√≥n civil del matrimonio.
C) Como un fen√≥meno marginal sin impacto en la configuraci√≥n jur√≠dica del matrimonio.
OK: B
EXP: Hist√≥ricamente, el Derecho can√≥nico influy√≥ en categor√≠as y soluciones luego incorporadas o adaptadas en la regulaci√≥n civil.


#ID=1.1

// [4]
Q: Antes de la Ley 13/2005, ¬øqu√© requisito estructural se exig√≠a para contraer matrimonio en Espa√±a?
A) Que existiera convivencia previa continuada entre los contrayentes.
B) Que se tratara de la uni√≥n entre un hombre y una mujer.
C) Que el v√≠nculo se celebrara necesariamente mediante rito religioso.
OK: B
EXP: El modelo anterior a 2005 part√≠a de la heterosexualidad como requisito del matrimonio civil.

// [5]
Q: ¬øQu√© lectura se sostuvo tradicionalmente del art. 32 CE respecto del modelo matrimonial?
A) Que el precepto garantizaba un matrimonio exclusivamente religioso.
B) Que el precepto confirmaba impl√≠citamente la concepci√≥n heterosexual del matrimonio.
C) Que el precepto impon√≠a un sistema de libertad total de forma matrimonial.
OK: B
EXP: Se entendi√≥ que ‚Äúhombre y mujer‚Äù apuntalaba el modelo heterosexual vigente antes de 2005.

// [6]
Q: ¬øQu√© tesis defendi√≥ una parte minoritaria de la doctrina sobre personas transexuales antes de las reformas m√°s recientes?
A) Que pod√≠an contraer matrimonio tras reconocimiento judicial del cambio de sexo.
B) Que el cambio registral imped√≠a cualquier forma de matrimonio.
C) Que el matrimonio quedaba sujeto a autorizaci√≥n administrativa previa.
OK: A
EXP: Se defendi√≥ que, reconocido el cambio de sexo, pod√≠a sostenerse la aptitud matrimonial, aunque con debate doctrinal.

// [7]
Q: En el itinerario normativo descrito, ¬øqu√© papel cumple la Ley 3/2007?
A) Elimina la relevancia del sexo registral en todo el ordenamiento civil.
B) Establece criterios para la rectificaci√≥n registral del sexo, con proyecci√≥n jur√≠dica.
C) Reconoce directamente el matrimonio entre personas del mismo sexo.
OK: B
EXP: La Ley 3/2007 regula la rectificaci√≥n registral del sexo; luego su enfoque queda superado por la Ley 4/2023.

// [8]
Q: ¬øQu√© efecto destaca el texto respecto de la Ley 4/2023 en relaci√≥n con el matrimonio?
A) Restringe el acceso al matrimonio en funci√≥n de la identidad de g√©nero.
B) Proclama el derecho a contraer matrimonio conforme al C√≥digo Civil y ajusta el marco registral.
C) Traslada la regulaci√≥n matrimonial a las Comunidades Aut√≥nomas.
OK: B
EXP: La Ley 4/2023 refuerza igualdad y autodeterminaci√≥n, y modifica el art. 44 CC proclamando el derecho a contraer matrimonio.


#ID=1.2

// [9]
Q: Tras la admisi√≥n del matrimonio entre personas del mismo sexo, ¬øqu√© ocurre con la monogamia?
A) Se sustituye por un sistema abierto a m√°s de dos contrayentes.
B) Se mantiene: el matrimonio se celebra entre dos personas, y solo dos.
C) Se convierte en una regla dispositiva libremente renunciable.
OK: B
EXP: El texto afirma que la monogamia permanece como nota estructural: dos personas, con independencia del sexo.

// [10]
Q: ¬øQu√© discusi√≥n se menciona sobre la posible evoluci√≥n futura del modelo monog√°mico?
A) Que la monogamia ya ha sido derogada por el Derecho positivo.
B) Que algunos autores plantean, por criterios sociol√≥gicos, una eventual superaci√≥n del modelo monog√°mico.
C) Que el sistema monog√°mico solo rige en el matrimonio religioso.
OK: B
EXP: Se alude a debates doctrinales (no a cambios vigentes) sobre hipot√©ticas evoluciones culturales y jur√≠dicas.


#ID=1.3

// [11]
Q: ¬øQu√© describe mejor la ‚Äúcomunidad de vida y existencia‚Äù como nota del matrimonio?
A) Un v√≠nculo centrado en intercambios patrimoniales con autonom√≠a contractual plena.
B) Una relaci√≥n √≠ntima y estable que abarca aspectos esenciales de la vida, sin p√©rdida de individualidad.
C) Una convivencia ocasional orientada a fines espec√≠ficos y limitados.
OK: B
EXP: El texto define el matrimonio como relaci√≥n estable e integral de vida en com√∫n, manteni√©ndose la individualidad de cada c√≥nyuge.

// [12]
Q: ¬øQu√© exclusi√≥n conceptual formula el texto al definir el matrimonio por su comunidad de vida?
A) Excluye v√≠nculos que busquen satisfacer necesidades pasajeras sin voluntad de convivencia aut√©ntica.
B) Excluye solo los matrimonios religiosos, por carecer de efectos civiles.
C) Excluye los matrimonios con r√©gimen econ√≥mico pactado.
OK: A
EXP: Se niega que el matrimonio sea uni√≥n moment√°nea o puramente afectiva/carnal sin voluntad de comunidad de vida real.

// [13]
Q: ¬øPor qu√© se mencionan los ‚Äúmatrimonios de complacencia‚Äù en este ep√≠grafe?
A) Porque son la forma ordinaria de matrimonio civil tras 2005.
B) Porque ilustran un supuesto en que falta el prop√≥sito de constituir verdadera comunidad de vida.
C) Porque demuestran que la solemnidad es innecesaria si hay convivencia.
OK: B
EXP: Se usan como ejemplo negativo: finalidad ajena a la convivencia real, incompatible con la idea de comunidad de vida.


#ID=1.4

// [14]
Q: Seg√∫n el texto, ¬øpor qu√© la estabilidad se considera inherente al matrimonio?
A) Porque se presume una permanencia como consecuencia l√≥gica de la comunidad de vida.
B) Porque la ley exige una duraci√≥n m√≠nima para que el matrimonio sea v√°lido.
C) Porque la estabilidad deriva exclusivamente del r√©gimen econ√≥mico matrimonial.
OK: A
EXP: La estabilidad aparece como corolario de la comunidad de vida y existencia, aunque no implique perpetuidad.

// [15]
Q: ¬øQu√© precisi√≥n hace el texto sobre estabilidad e indisolubilidad en el sistema espa√±ol actual?
A) Que la legislaci√≥n espa√±ola contempor√°nea mantiene la indisolubilidad vitalicia como regla.
B) Que la concepci√≥n de perpetuidad no se corresponde con el Derecho espa√±ol tras la Ley 30/1981.
C) Que la estabilidad solo existe en matrimonios can√≥nicos con efectos civiles.
OK: B
EXP: La permanencia no equivale a indisolubilidad: el marco espa√±ol posterior a 1981 admite la disoluci√≥n del v√≠nculo.


#ID=1.5

// [16]
Q: ¬øQu√© funci√≥n cumplen las formalidades en el consentimiento matrimonial, seg√∫n el texto?
A) Sustituir la voluntad de los contrayentes por un acto administrativo.
B) Garantizar la concurrencia de los presupuestos exigidos por el ordenamiento.
C) Permitir que el matrimonio produzca efectos solo econ√≥micos.
OK: B
EXP: La solemnidad asegura requisitos legales y validez del consentimiento como presupuesto del estatuto matrimonial.

// [17]
Q: Si no se cumplen los requisitos formales, aun existiendo convivencia y elementos materiales, ¬øc√≥mo califica el texto la relaci√≥n?
A) Como matrimonio irregular plenamente v√°lido.
B) Como uni√≥n de hecho (pareja de hecho / convivencia more uxorio).
C) Como contrato civil de convivencia con efectos autom√°ticos.
OK: B
EXP: Falta el elemento formal; por ello se califica como uni√≥n de hecho, aunque exista convivencia.

// [18]
Q: ¬øQu√© afirma el texto sobre la regulaci√≥n general estatal de las parejas de hecho?
A) Que existe una regulaci√≥n estatal general completa y uniforme.
B) Que no existe una regulaci√≥n estatal general, aunque s√≠ normas auton√≥micas y registro para ciertos efectos.
C) Que las parejas de hecho se regulan √∫nicamente por el C√≥digo Civil, por analog√≠a.
OK: B
EXP: Se destaca ausencia de r√©gimen estatal general, coexistiendo normas auton√≥micas y mecanismos registrales para acreditar efectos concretos.

// [19]
Q: En caso de ruptura de una pareja de hecho, ¬øqu√© pauta general indica el texto sobre el r√©gimen aplicable?
A) Procede siempre la aplicaci√≥n anal√≥gica del r√©gimen matrimonial.
B) En general no procede la analog√≠a matrimonial; se atiende a normativa existente, pactos o criterios como enriquecimiento injusto.
C) Se aplica autom√°ticamente el r√©gimen econ√≥mico de gananciales.
OK: B
EXP: El texto subraya que la analog√≠a matrimonial suele rechazarse, acudiendo a pactos, normas disponibles y soluciones jurisprudenciales.
`;

const BANCO_2 = `#ID=2

// [20]
Q: ¬øQu√© caracteriza, seg√∫n el texto, la ruptura hist√≥rica introducida por la Ley 13/2005?
A) La sustituci√≥n del matrimonio civil por un sistema de uniones de hecho.
B) La superaci√≥n del requisito de heterosexualidad en la concepci√≥n secular del matrimonio.
C) La eliminaci√≥n de la solemnidad como requisito del matrimonio.
OK: B
EXP: La reforma rompe con la concepci√≥n tradicional presidida por la heterosexualidad, abriendo el matrimonio a personas del mismo sexo.

// [21]
Q: ¬øC√≥mo encuadra el texto la reforma de 2005 en una perspectiva hist√≥rica m√°s amplia?
A) Como una transformaci√≥n comparable a otros cambios que acabaron consolid√°ndose como principios aceptados.
B) Como una excepci√≥n aislada sin paralelos en la evoluci√≥n jur√≠dica.
C) Como una reforma meramente terminol√≥gica sin impacto estructural.
OK: A
EXP: Se compara con transformaciones hist√≥ricas (igualdad, abolici√≥n de esclavitud) que con el tiempo se consolidaron.

// [22]
Q: ¬øQu√© hecho estad√≠stico destaca el texto sobre el matrimonio homosexual en Espa√±a?
A) Que supera ampliamente el diez por ciento de los n√∫cleos familiares.
B) Que su incidencia es reducida y no alcanza el uno por ciento del total de n√∫cleos familiares.
C) Que constituye la forma mayoritaria de matrimonio desde 2005.
OK: B
EXP: El texto subraya la distancia entre percepci√≥n social y realidad demogr√°fica, con incidencia estad√≠stica baja.

// [23]
Q: En el plano comparado e internacional, ¬øqu√© contraste subraya el texto?
A) Universalidad del reconocimiento del matrimonio homosexual en todos los pa√≠ses.
B) Convivencia de modelos: pa√≠ses que lo reconocen y otros donde la homosexualidad sigue siendo delito.
C) Prohibici√≥n del matrimonio homosexual en la Uni√≥n Europea.
OK: B
EXP: Se describe diversidad comparada: reconocimiento en muchos Estados y criminalizaci√≥n en otros.


#ID=3

// [24]
Q: ¬øCu√°l es el n√∫cleo del debate jur√≠dico sobre la ‚Äúnaturaleza‚Äù del matrimonio, seg√∫n el texto?
A) Definir socialmente qu√© es una pareja y sus costumbres.
B) Determinar c√≥mo debe calificarse t√©cnicamente el matrimonio en categor√≠as jur√≠dicas.
C) Sustituir el matrimonio por un contrato de convivencia regulado.
OK: B
EXP: El problema no es el concepto social del matrimonio, sino su calificaci√≥n jur√≠dica (contrato, negocio, instituci√≥n).

// [25]
Q: ¬øPor qu√© el texto afirma que el debate persiste con independencia del divorcio o del matrimonio homosexual?
A) Porque la cuesti√≥n t√©cnica de calificaci√≥n no depende de que exista o no una modalidad concreta.
B) Porque el divorcio elimina cualquier necesidad de calificaci√≥n jur√≠dica.
C) Porque el matrimonio homosexual impide toda discusi√≥n doctrinal.
OK: A
EXP: La discusi√≥n es estructural: c√≥mo encajar jur√≠dicamente el matrimonio, haya o no divorcio o matrimonio entre personas del mismo sexo.


#ID=3.1

// [26]
Q: ¬øQu√© raz√≥n hizo especialmente atractiva para canonistas la tesis contractual del matrimonio?
A) Permit√≠a fundamentar el v√≠nculo y la indisolubilidad en el principio pacta sunt servanda.
B) Permit√≠a transformar el matrimonio en un contrato puramente patrimonial.
C) Permit√≠a prescindir del consentimiento como elemento central.
OK: A
EXP: La tesis contractual serv√≠a para justificar v√≠nculo e indisolubilidad mediante la l√≥gica obligacional del pacto.

// [27]
Q: ¬øQu√© objeci√≥n principal formula el texto contra concebir el matrimonio como contrato civil t√≠pico?
A) Que el contrato civil no exige consentimiento.
B) Que la autonom√≠a privada y la ineficacia por incumplimiento no encajan con el esquema matrimonial.
C) Que todo contrato civil debe ser necesariamente religioso.
OK: B
EXP: El contrato t√≠pico se asienta en libertad de estipulaci√≥n e ineficacia por incumplimiento, incompatibles con el estatuto matrimonial.

// [28]
Q: ¬øPor qu√© resulta insatisfactoria la idea de ‚Äúcontrato sui generis‚Äù aplicada al matrimonio?
A) Porque el matrimonio no contiene consentimientos coincidentes.
B) Porque no tiene patrimonialidad t√©cnica y sus efectos est√°n predeterminados, lo que impide aplicar el r√©gimen contractual.
C) Porque el Derecho positivo proh√≠be cualquier calificaci√≥n jur√≠dica del matrimonio.
OK: B
EXP: La predeterminaci√≥n normativa y falta de patrimonialidad t√©cnica hacen inadecuada la traslaci√≥n del r√©gimen de contratos.


#ID=3.2

// [29]
Q: ¬øQu√© pretend√≠a lograr la calificaci√≥n del matrimonio como ‚Äúnegocio jur√≠dico de Derecho de familia‚Äù?
A) Explicar su singularidad encaj√°ndolo en una categor√≠a m√°s amplia que el contrato.
B) Convertir el matrimonio en un acuerdo patrimonial libremente modulable.
C) Eliminar el car√°cter imperativo del estatuto matrimonial.
OK: A
EXP: Se buscaba una etiqueta conceptual para explicar la singularidad del matrimonio dentro del Derecho de familia.

// [30]
Q: ¬øQu√© cr√≠tica central realiza el texto a esa calificaci√≥n como negocio jur√≠dico?
A) Que aclara por completo el r√©gimen normativo del matrimonio.
B) Que es una abstracci√≥n que no mejora la comprensi√≥n ni explica efectos materiales predeterminados.
C) Que impide la existencia del consentimiento matrimonial.
OK: B
EXP: El texto afirma que no aclara r√©gimen ni efectos, y puede generar indefinici√≥n y confusi√≥n conceptual.


#ID=3.3

// [31]
Q: ¬øQu√© ejemplo utiliza el texto para mostrar que el consentimiento es imprescindible pero no suficiente para el matrimonio?
A) La diferencia entre matrimonio y uni√≥n de hecho pese a existir convivencia.
B) La diferencia entre matrimonio y tutela.
C) La diferencia entre matrimonio y filiaci√≥n.
OK: A
EXP: La comparaci√≥n con uniones de hecho evidencia que el consentimiento, sin marco institucional y forma, no basta.

// [32]
Q: ¬øQu√© significa que el ‚Äúestatuto matrimonial‚Äù est√© sustra√≠do a la voluntad de los contrayentes?
A) Que los contrayentes fijan libremente el contenido esencial del v√≠nculo.
B) Que la ley fija imperativamente el r√©gimen b√°sico, salvo aspectos concretos como el r√©gimen econ√≥mico.
C) Que el estatuto depende exclusivamente de la religi√≥n de los contrayentes.
OK: B
EXP: La instituci√≥n tiene contenido normativamente predeterminado, con margen limitado (p. ej., r√©gimen econ√≥mico).

// [33]
Q: ¬øQu√© conclusi√≥n institucional extrae el texto sobre la naturaleza del matrimonio?
A) Que es un contrato t√≠pico sometido a autonom√≠a privada plena.
B) Que es una instituci√≥n jur√≠dica aut√≥noma con normativa espec√≠fica para nacimiento, desarrollo y crisis.
C) Que es una uni√≥n de hecho con efectos civiles ocasionales.
OK: B
EXP: La concepci√≥n institucional subraya un r√©gimen propio, imperativo en lo esencial, y estructurado por el Derecho positivo.


#ID=4

// [34]
Q: ¬øQu√© designa, en sentido jur√≠dico, la expresi√≥n ‚Äúsistema matrimonial‚Äù?
A) El r√©gimen econ√≥mico elegido por los c√≥nyuges tras casarse.
B) La ordenaci√≥n estatal de las formas o ritos a los que se reconoce validez civil.
C) La regulaci√≥n interna de las confesiones religiosas sobre el matrimonio.
OK: B
EXP: El sistema matrimonial define qu√© formas de celebraci√≥n reconoce el Estado con eficacia civil.

// [35]
Q: ¬øPor qu√© el texto vincula el problema del sistema matrimonial a la relaci√≥n entre poder civil y confesiones religiosas?
A) Porque en Europa el matrimonio civil fue anterior hist√≥ricamente al can√≥nico.
B) Porque la precedencia hist√≥rica del matrimonio can√≥nico condiciona la configuraci√≥n posterior del matrimonio civil.
C) Porque el Estado carece de potestad normativa en materia matrimonial.
OK: B
EXP: La historia del matrimonio can√≥nico y su jurisdicci√≥n influy√≥ en c√≥mo los Estados modernos dise√±aron su sistema matrimonial.

// [36]
Q: ¬øPor qu√© la decisi√≥n sobre el sistema matrimonial se califica como opci√≥n pol√≠tica relevante?
A) Porque determina si el Estado asume en exclusiva la potestad normativa y jurisdiccional o la comparte en alg√∫n grado.
B) Porque permite a cada ciudadano crear su propia forma de matrimonio sin formalidades.
C) Porque elimina la necesidad de inscripci√≥n registral.
OK: A
EXP: Elegir sistema implica decidir el reparto de competencias normativas y jurisdiccionales entre Estado y confesiones.


#ID=5

// [37]
Q: ¬øQu√© principios constitucionales hacen incompatible el sistema de matrimonio civil subsidiario propio de Estados confesionales?
A) Aconfesionalidad del Estado, libertad religiosa y recuperaci√≥n del poder civil en materia matrimonial.
B) Unidad religiosa del Estado y jurisdicci√≥n eclesi√°stica exclusiva.
C) Supremac√≠a del Derecho can√≥nico en relaciones familiares.
OK: A
EXP: El texto cita aconfesionalidad (art. 16.3), libertad religiosa (art. 16) y poder civil (art. 32.2) como marco incompatible con subsidiariedad confesional.

// [38]
Q: Seg√∫n el texto, ¬øqu√© rasgo define al sistema resultante tras las reformas de 1981 en Espa√±a?
A) Un sistema de libertad de forma sin formalidades obligatorias.
B) Un sistema electivo formal y facultativo: forma m√∫ltiple con clase √∫nica civil y regulaci√≥n estatal.
C) Un sistema exclusivamente religioso con eficacia civil autom√°tica.
OK: B
EXP: Se reconoce eficacia civil a formas religiosas, pero el Estado se reserva la regulaci√≥n jur√≠dica del matrimonio.


#ID=6

// [39]
Q: En el C√≥digo Civil vigente, ¬øqu√© regla fija el art. 42 sobre la promesa de matrimonio?
A) Produce obligaci√≥n exigible de contraer matrimonio si fue formalizada por escrito.
B) No produce obligaci√≥n de contraerlo ni permite demandar su cumplimiento.
C) Obliga a cumplir lo pactado bajo cl√°usula penal si no se celebra.
OK: B
EXP: Se protege la libertad matrimonial: no hay acci√≥n para exigir celebraci√≥n ni cumplimiento de pactos vinculados a no celebrar.

// [40]
Q: ¬øQu√© consecuencia jur√≠dica principal atribuye el art. 43 CC al incumplimiento ‚Äúsin causa‚Äù de una promesa cierta de matrimonio?
A) Indemnizaci√≥n general por da√±os morales y aplicaci√≥n preferente del art. 1902 CC.
B) Resarcimiento de gastos y obligaciones contra√≠das en consideraci√≥n al matrimonio prometido, con alcance limitado.
C) Nulidad de cualquier relaci√≥n posterior entre los prometidos.
OK: B
EXP: La consecuencia se limita al resarcimiento patrimonial (gastos/obligaciones) en consideraci√≥n al matrimonio, con r√©gimen y l√≠mites propios.
`;
    const BANCO_3 = `...Pega aqu√≠ tu BANCO_3 completo...`;
    const BANCO_4 = `...Pega aqu√≠ tu BANCO_4 completo...`;
    const BANCO_5 = `...Pega aqu√≠ tu BANCO_5 completo...`;

    const BANCO_TEXTO = [BANCO_1, BANCO_2, BANCO_3, BANCO_4, BANCO_5]
      .map(s => String(s || "").trim())
      .filter(Boolean)
      .join("\n\n");

    /* =========================
       HELPERS
    ========================= */
    function escapeHtml(s){
      return String(s ?? "")
        .replace(/&/g,"&amp;")
        .replace(/</g,"&lt;")
        .replace(/>/g,"&gt;")
        .replace(/"/g,"&quot;")
        .replace(/'/g,"&#039;");
    }
    
    function quitarTituloRepetidoSeguro(texto, titulo){
  const t0 = String(texto || "");
  const h0 = String(titulo || "");
  if(!t0.trim() || !h0.trim()) return t0.trim();

  // Normaliza: min√∫sculas + espacios raros (NBSP) + BOM
  const clean = s => String(s)
    .replace(/^\uFEFF/, "")          // BOM
    .replace(/\u00A0/g, " ")         // NBSP -> espacio normal
    .replace(/\s+/g, " ")
    .trim()
    .toLowerCase();

  const t = clean(t0);
  const h = clean(h0);

  if(!t.startsWith(h)) return t0.trim();

  // Corta del texto ORIGINAL, pero usando la longitud del t√≠tulo ORIGINAL
  // (buscamos el match real al principio ignorando may√∫sculas y espacios raros)
  const re = new RegExp(
    "^\\s*" + h0.trim()
      .replace(/[.*+?^${}()|[\]\\]/g, "\\$&")   // escape regex
      .replace(/\s+/g, "[\\s\\u00A0]+")         // admite NBSP
    + "[\\s\\u00A0]+",
    "i"
  );

  return t0.replace(re, "").trim();
}




function formatearParrafos(t){
  const lines = String(t ?? "").replace(/\r/g,"").split("\n");

  const isBullet = (s) => /^\s*(‚Ä¢|‚Äì|-)\s+/.test(s);
  const isEpig   = (s) => /^\s*\d+(?:\.\d+)*\.\s+/.test(s);     // 1. / 1.1. / 1.1.1.
  const isEnum   = (s) => /^\s*\d+\s*-\s+/.test(s);             // 1- ...
  const newBlock = (s) => isBullet(s) || isEpig(s) || isEnum(s);

  const paras = [];
  let cur = "";

  for(let i=0;i<lines.length;i++){
    const raw = lines[i];
    const line = raw.trim();

    // ‚úÖ l√≠nea vac√≠a = FIN de p√°rrafo (esto es lo que te faltaba)
    if(!line){
      if(cur) paras.push(cur.trim());
      cur = "";
      continue;
    }

    // ‚úÖ listas/ep√≠grafes/enumeraciones: cada uno en su propio p√°rrafo
    if(newBlock(line)){
      if(cur) paras.push(cur.trim());
      paras.push(line);
      cur = "";
      continue;
    }

    // empieza p√°rrafo
    if(!cur){
      cur = line;
      continue;
    }

    // ‚úÖ une cortes t√≠picos de PDF (sin cargarte p√°rrafos)
    const prevEndsSentence = /[.!?:]$/.test(cur.trim());
    const nextStartsLower  = /^[a-z√°√©√≠√≥√∫√±]/.test(line);

    if(!prevEndsSentence && nextStartsLower){
      cur += " " + line;
    }else{
      paras.push(cur.trim());
      cur = line;
    }
  }

  if(cur) paras.push(cur.trim());

  return paras.map(p => `<p>${escapeHtml(p)}</p>`).join("");
}
    function normalizeKey(s){
      return String(s || "")
        .trim()
        .toLowerCase()
        .replace(/\s+/g," ")
        .slice(0,220);
    }

    // Jerarqu√≠a ep√≠grafes
    function esDescendiente(idHijo, idPadre){
      return String(idHijo).startsWith(String(idPadre) + ".");
    }
    function parentId(id){
      const parts = String(id || "").split(".");
      if(parts.length <= 1) return null;
      parts.pop();
      return parts.join(".");
    }

    /* =========================
       PDF -> ep√≠grafes
    ========================= */
    function extraerEncabezados(){
      // Soporta: "1. T√çTULO" y "1.1. T√çTULO"
      const re = /^\s*(\d+(?:\.\d+)*)\.\s+(.+?)\s*$/;
      const lines = String(PDF_TEXTO).replace(/\r/g,"").split("\n");
      const out = [];
      for(const l of lines){
        const m = l.match(re);
        if(!m) continue;
        out.push({ id:m[1], titulo:`${m[1]}. ${m[2].trim()}` });
      }
      return out;
    }

    function textoPorId(id){
      if(!id) return "";
      const safe = id.replace(/\./g,"\\.");
      const reStart = new RegExp(`(^|\\n)${safe}\\.\\s+`, "m");
      const full = String(PDF_TEXTO);
      const m = full.match(reStart);
      if(!m) return "";
      const startIdx = full.indexOf(m[0]) + m[0].length;
      const rest = full.slice(startIdx);
      const nextIdx = rest.search(/\n\s*\d+(?:\.\d+)*\.\s+/);
      const chunk = (nextIdx === -1 ? rest : rest.slice(0, nextIdx)).trim();
      return chunk;
    }

    /* =========================
       PARSER banco
    ========================= */
    function parseBanco(texto){
      const t = String(texto || "").replace(/\r/g, "");
      const bloques = t.split(/\n(?=#ID\s*=\s*)/g).map(x=>x.trim()).filter(Boolean);
      const QUIZ = {};
      for(const bloque of bloques){
        const mId = bloque.match(/^#ID\s*=\s*([0-9]+(?:\.[0-9]+)*)\s*$/m);
        if(!mId) continue;
        const id = mId[1];

        const sinHeader = bloque.replace(/^#ID\s*=\s*[0-9]+(?:\.[0-9]+)*\s*$/m, "").trim();
        const partesQ = sinHeader.split(/\n(?=Q:\s*)/g).map(x=>x.trim()).filter(Boolean);

        const preguntas = [];
        for(const pq of partesQ){
          // ‚úÖ acepta: // [1]  o  // N: 1
          const nMatch = pq.match(/^\/\/\s*(?:N:|\[)\s*([0-9]{1,3})\s*\]?\s*$/m);
          const qMatch = pq.match(/^Q:\s*(.+)$/m);
          if(!qMatch) continue;

          const aMatch = pq.match(/^A\)\s*(.+)$/m);
          const bMatch = pq.match(/^B\)\s*(.+)$/m);
          const cMatch = pq.match(/^C\)\s*(.+)$/m);
          const okMatch = pq.match(/^OK:\s*([ABC])\s*$/m);
          const expMatch = pq.match(/^EXP:\s*([\s\S]+)$/m);

          if(!aMatch || !bMatch || !cMatch || !okMatch) continue;

          const preguntaTxt = qMatch[1].trim();
          const uid = `${id}::${normalizeKey(preguntaTxt)}`;

          preguntas.push({
            __id: id,
            __uid: uid,
            __n: nMatch ? Number(nMatch[1]) : null,
            pregunta: preguntaTxt,
            a: aMatch[1].trim(),
            b: bMatch[1].trim(),
            c: cMatch[1].trim(),
            correcta: okMatch[1].toLowerCase(),
            explicacion: expMatch ? expMatch[1].trim() : ""
          });
        }

        if(!QUIZ[id]) QUIZ[id] = [];
        QUIZ[id].push(...preguntas);
      }
      return QUIZ;
    }

    const QUIZ = parseBanco(BANCO_TEXTO);

    function buildTemaPool(QUIZ){
      const pool = [];
      for(const id of Object.keys(QUIZ || {})){
        const list = QUIZ[id];
        if(Array.isArray(list)) pool.push(...list);
      }
      return pool;
    }
    let TEMA_POOL = buildTemaPool(QUIZ);

    /* =========================
       STORAGE
    ========================= */
    const STORAGE_KEY = "DA_TEMA2_STATS_V1";
    function loadStore(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return { wrongUids: {}, stats: { ok:0, bad:0, blank:0 } };
        const parsed = JSON.parse(raw);
        return {
          wrongUids: parsed.wrongUids || {},
          stats: parsed.stats || { ok:0, bad:0, blank:0 }
        };
      }catch{
        return { wrongUids: {}, stats: { ok:0, bad:0, blank:0 } };
      }
    }
    function saveStore(){
      try{
        localStorage.setItem(STORAGE_KEY, JSON.stringify(STORE));
      }catch{}
    }
    let STORE = loadStore();

    function markWrong(uid){ STORE.wrongUids[uid] = true; saveStore(); }
    function clearWrong(uid){ delete STORE.wrongUids[uid]; saveStore(); }
    function isWrong(uid){ return !!STORE.wrongUids[uid]; }

    /* =========================
       DOM refs
    ========================= */
    const modalOverlay = document.getElementById("modalOverlay");
    const btnCloseModal = document.getElementById("btnCloseModal");
    const btnNextQuestion = document.getElementById("btnNextQuestion");
    const btnBlank = document.getElementById("btnBlank");

    const modalPill = document.getElementById("modalPill");
    const modalTitle = document.getElementById("modalTitle");
    const modalQuestion = document.getElementById("modalQuestion");
    const modalOptions = document.getElementById("modalOptions");
    const modalFeedback = document.getElementById("modalFeedback");
    const modalFeedbackTitle = document.getElementById("modalFeedbackTitle");
    const modalExplanation = document.getElementById("modalExplanation");
    const modalCounter = document.getElementById("modalCounter");
    const scoreLine = document.getElementById("scoreLine");
    const modalTimer = document.getElementById("modalTimer");

    const btnTemaRandom = document.getElementById("btnTemaRandom");
    const selTemaN = document.getElementById("selTemaN");
    const btnSoloFalladas = document.getElementById("btnSoloFalladas");
    const btnResetStats = document.getElementById("btnResetStats");
    const badgeTemaTotal = document.getElementById("badgeTemaTotal");

    /* =========================
       ESTADO QUIZ
    ========================= */
    let currentMode = "epigrafe";
    let currentId = null;
    let deck = [];
    let idx = 0;
    let currentQ = null;
    let answered = false;

    let ses_ok = 0, ses_bad = 0, ses_blank = 0;

    function computeUNEDGrade(){
      const total = ses_ok + ses_bad + ses_blank;
      const puntos =
        (ses_ok * SCORE_OK) -
        (ses_bad * SCORE_BAD) +
        (ses_blank * SCORE_BLANK);
      return { puntos, total };
    }
    function renderScoreLine(){
      const { puntos, total } = computeUNEDGrade();
      scoreLine.textContent =
        `Aciertos ${ses_ok} ¬∑ Fallos ${ses_bad} ¬∑ Blancos ${ses_blank} ¬∑ Puntos ${puntos.toFixed(2)} (de ${total})`;
    }

    /* =========================
       TIMER
    ========================= */
    let timerStart = 0;
    let timerHandle = null;

    function shuffle(arr){
      const a = arr.slice();
      for(let i=a.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [a[i],a[j]] = [a[j],a[i]];
      }
      return a;
    }
    function fmtTime(ms){
      const s = Math.floor(ms/1000);
      const mm = String(Math.floor(s/60)).padStart(2,"0");
      const ss = String(s%60).padStart(2,"0");
      return `${mm}:${ss}`;
    }
    function stopTimer(){
      if(timerHandle){
        clearInterval(timerHandle);
        timerHandle = null;
      }
    }
    function startTimer(){
      stopTimer();
      timerStart = Date.now();
      timerHandle = setInterval(()=>{
        modalTimer.textContent = fmtTime(Date.now() - timerStart);
      }, 250);
    }
    function openModal(){
      modalOverlay.classList.add("show");
      modalOverlay.setAttribute("aria-hidden","false");
      startTimer();
    }
    function closeModal(){
      modalOverlay.classList.remove("show");
      modalOverlay.setAttribute("aria-hidden","true");
      stopTimer();

      currentMode = "epigrafe";
      currentId = null;
      deck = [];
      idx = 0;
      currentQ = null;
      answered = false;

      modalOptions.innerHTML = "";
      modalFeedback.className = "feedback";
      modalFeedback.classList.remove("show");
      modalQuestion.textContent = "‚Äî";
      modalCounter.textContent = "0/0";
      modalTimer.textContent = "00:00";
    }

    function setFeedback(kind, title, explanation){
      modalFeedback.classList.remove("ok","bad");
      modalFeedback.classList.add(kind);
      modalFeedbackTitle.textContent = title;
      modalExplanation.textContent = explanation ? explanation : "";
      modalFeedback.classList.add("show");
    }

    /* =========================
       DECK BUILDERS
    ========================= */
    function buildDeckForEpigrafe(id){
      const list = Array.isArray(QUIZ[id]) ? QUIZ[id] : [];
      return shuffle(list);
    }
    function buildDeckForTema(n){
      const pool = TEMA_POOL.slice();
      const barajado = shuffle(pool);
      const wanted = Math.max(1, Math.min(Number(n || 20), barajado.length));
      return barajado.slice(0, wanted);
    }
    function buildDeckForFalladas(){
      const pool = TEMA_POOL.filter(q => isWrong(q.__uid));
      return shuffle(pool);
    }

    function getNextFromDeck(){
      if(!deck.length) return null;
      if(idx >= deck.length){
        if(currentMode === "tema") return null;
        deck = shuffle(deck);
        idx = 0;
      }
      const q = deck[idx];
      idx += 1;
      return q;
    }

    /* =========================
       RENDER PREGUNTA
    ========================= */
    function renderQuestion(){
      const q = getNextFromDeck();
      if(!q){
        alert("Fin del test.");
        closeModal();
        return;
      }

      currentQ = q;
      answered = false;
      modalFeedback.className = "feedback";
      modalFeedback.classList.remove("show");

      modalPill.textContent = q.__id || currentId || "‚Äî";
      modalTitle.textContent =
        currentMode === "tema" ? "Modo tema (aleatorio)" :
        currentMode === "falladas" ? "Solo falladas" :
        "Por ep√≠grafe";

      modalQuestion.textContent = q.pregunta;
      modalCounter.textContent = `${Math.min(idx, deck.length)}/${deck.length}`;

      let opts = [
        { label:"A", text:q.a, isCorrect: q.correcta === "a" },
        { label:"B", text:q.b, isCorrect: q.correcta === "b" },
        { label:"C", text:q.c, isCorrect: q.correcta === "c" },
      ];
      opts = shuffle(opts);

      modalOptions.innerHTML = opts.map(o=>`
        <button class="optBtn" type="button" data-correct="${o.isCorrect ? "1" : "0"}">
          <span class="k">${o.label}</span>${escapeHtml(o.text)}
        </button>
      `).join("");

      [...modalOptions.querySelectorAll(".optBtn")].forEach(btn=>{
        btn.addEventListener("click", ()=>{
          if(answered) return;
          answered = true;

          const chosenCorrect = btn.getAttribute("data-correct") === "1";

          if(chosenCorrect){
            ses_ok += 1;
            clearWrong(q.__uid);
            setFeedback("ok", "Correcto ‚úÖ", q.explicacion);
          }else{
            ses_bad += 1;
            markWrong(q.__uid);
            const correctLabel = (q.correcta || "").toUpperCase();
            setFeedback("bad", `Incorrecto ‚ùå (Correcta: ${correctLabel})`, q.explicacion);
          }

          renderScoreLine();
          refreshTemaStats();
        });
      });
    }

    /* =========================
       START MODOS
    ========================= */
    function startQuizForId(id){
      const list = Array.isArray(QUIZ[id]) ? QUIZ[id] : [];
      if(!list.length){
        alert(`No hay preguntas cargadas para el ep√≠grafe ${id}.`);
        return;
      }
      currentMode = "epigrafe";
      currentId = id;
      deck = buildDeckForEpigrafe(id);
      idx = 0;
      ses_ok = 0; ses_bad = 0; ses_blank = 0;
      renderScoreLine();
      openModal();
      renderQuestion();
    }

    function startQuizTema(){
      if(!TEMA_POOL.length){
        alert("No hay preguntas cargadas en el tema todav√≠a.");
        return;
      }
      const n = selTemaN ? Number(selTemaN.value) : 20;
      currentMode = "tema";
      currentId = "TEMA";
      deck = buildDeckForTema(n);
      idx = 0;
      ses_ok = 0; ses_bad = 0; ses_blank = 0;
      renderScoreLine();
      openModal();
      renderQuestion();
    }

    function startQuizFalladas(){
      const d = buildDeckForFalladas();
      if(!d.length){
        alert("No tienes falladas guardadas a√∫n.");
        return;
      }
      currentMode = "falladas";
      currentId = "FALLADAS";
      deck = d;
      idx = 0;
      ses_ok = 0; ses_bad = 0; ses_blank = 0;
      renderScoreLine();
      openModal();
      renderQuestion();
    }

    function blankQuestion(){
      if(answered) return;
      answered = true;
      ses_blank += 1;
      setFeedback("bad", "En blanco ‚ö™", currentQ ? currentQ.explicacion : "");
      renderScoreLine();
      refreshTemaStats();
    }

    function refreshTemaStats(){
      const total = TEMA_POOL.length;
      const wrongCount = Object.keys(STORE.wrongUids || {}).length;
      if(badgeTemaTotal){
        badgeTemaTotal.textContent = `${total} cargadas ¬∑ ${wrongCount} falladas guardadas`;
      }
      if(diag){
        diag.innerHTML = `Diagn√≥stico: <b>OK</b> ¬∑ Ep√≠grafes detectados: <b>${extraerEncabezados().length}</b> ¬∑ Preguntas cargadas: <b>${TEMA_POOL.length}</b>`;
      }
    }

    /* =========================
       ‚úÖ RENDER ACORDE√ìN EN CASCADA (√ÅRBOL)
    ========================= */
    const cont = document.getElementById("contenido");
    cont.innerHTML = "";

    const heads = extraerEncabezados();

    // Construye nodos
    const nodesById = new Map();
    heads.forEach(h=>{
      nodesById.set(h.id, { ...h, children: [] });
    });

    // Enlaza padre-hijo
    const roots = [];
    heads.forEach(h=>{
      const node = nodesById.get(h.id);
      const pid = parentId(h.id);
      if(pid && nodesById.has(pid)){
        nodesById.get(pid).children.push(node);
      }else{
        roots.push(node);
      }
    });

    // Ordena hijos num√©ricamente (1.10 despu√©s de 1.2, etc.)
    function cmpIds(a,b){
      const pa = a.id.split(".").map(Number);
      const pb = b.id.split(".").map(Number);
      const len = Math.max(pa.length, pb.length);
      for(let i=0;i<len;i++){
        const xa = pa[i] ?? -1;
        const xb = pb[i] ?? -1;
        if(xa !== xb) return xa - xb;
      }
      return 0;
    }
    function sortTree(list){
      list.sort(cmpIds);
      list.forEach(n=>sortTree(n.children));
    }
    sortTree(roots);

    // Render recursivo
function renderNode(node){
  let txt = textoPorId(node.id);
  const idea = (IDEAS_CLAVE[node.id] ?? "").toString().trim();
  const quizCount = Array.isArray(QUIZ[node.id]) ? QUIZ[node.id].length : 0;

  const titleNoId = node.titulo.replace(
    new RegExp("^" + node.id.replace(/\./g,"\\.") + "\\.\\s*"),
    ""
  );

  // ‚úÖ QUITA el t√≠tulo repetido al inicio del texto
  txt = quitarTituloRepetidoSeguro(txt, titleNoId);

  const d = document.createElement("details");
  d.open = false;
  d.dataset.id = node.id;

      d.innerHTML = `
        <summary>
          <div class="sumLeft">
            <span class="pill">${escapeHtml(node.id)}</span>
            <span class="sumTitle">${escapeHtml(titleNoId)}</span>
          </div>
          <div class="sumRight" style="display:flex; gap:10px; align-items:center;">
            ${quizCount ? `<span class="badge">${quizCount} preguntas</span>` : `<span class="badge"></span>`}
          </div>
        </summary>

        <div class="inner">
          ${txt ? `<div class="prio"><div class="tag">Texto prioritario</div>${formatearParrafos(txt)}</div>` : ""}
          ${idea ? `<div class="idea"><div class="tag">Idea clave</div>${escapeHtml(idea)}</div>` : ""}

          <div class="rowActions">
            ${quizCount ? `<button class="btn btnPrimary" type="button" data-quiz="${escapeHtml(node.id)}">Preg√∫ntame</button>` : ""}
            <span class="badge">Ep√≠grafe ${escapeHtml(node.id)}</span>
          </div>

          ${quizCount ? `
            <div class="quizBox">
              <div class="tag">Banco (cargado)</div>
              <div style="opacity:.85; font-size:13px">
                Tienes ${quizCount} preguntas en este ep√≠grafe.
              </div>
            </div>
          ` : ""}

          <div class="children" style="margin-top:10px; padding-left:14px; border-left:2px solid rgba(17,24,39,.08)"></div>
        </div>
      `;

      // ‚úÖ Cierre inteligente: deja abierto ancestros + descendientes; cierra lo dem√°s
      d.addEventListener("toggle", () => {
        if(!d.open) return;

        const idActual = d.dataset.id;

        cont.querySelectorAll("details").forEach(other=>{
          if(other === d) return;
          const otherId = other.dataset.id;
          if(!otherId) return;

          const esDescDeActual = esDescendiente(otherId, idActual);
          const esAncestroDeActual = esDescendiente(idActual, otherId);

          if(!esDescDeActual && !esAncestroDeActual){
            other.open = false;
          }
        });
      });

      // Render hijos dentro del padre (cascada real)
      const childrenBox = d.querySelector(".children");
      node.children.forEach(ch=>{
        childrenBox.appendChild(renderNode(ch));
      });

      return d;
    }

    if(!heads.length){
      cont.innerHTML = `
        <div class="prio">
          <div class="tag">No se detectaron ep√≠grafes</div>
          <div style="opacity:.85">
            El detector busca l√≠neas tipo <b>‚Äú1. T√çTULO‚Äù</b> o <b>‚Äú1.1. T√çTULO‚Äù</b> (con punto y espacio).<br><br>
            Primeros 300 caracteres del texto:<br><br>
            <code style="white-space:pre-wrap">${escapeHtml(PDF_TEXTO.slice(0,300))}</code>
          </div>
        </div>
      `;
    }else{
      roots.forEach(r=>cont.appendChild(renderNode(r)));
    }

    // Click de botones ‚ÄúPreg√∫ntame‚Äù
    cont.addEventListener("click", (e)=>{
      const btn = e.target.closest("button[data-quiz]");
      if(!btn) return;
      const id = btn.getAttribute("data-quiz");
      if(!id) return;
      startQuizForId(id);
    });

    /* =========================
       EVENTOS UI
    ========================= */
    btnCloseModal.addEventListener("click", closeModal);
    modalOverlay.addEventListener("click", (e)=>{
      if(e.target === modalOverlay) closeModal();
    });
    btnNextQuestion.addEventListener("click", renderQuestion);
    btnBlank.addEventListener("click", blankQuestion);

    document.addEventListener("keydown", (e)=>{
      if(!modalOverlay.classList.contains("show")) return;
      if(e.key === "Escape") closeModal();
      if(e.key === "Enter") renderQuestion();
    });

    btnTemaRandom.addEventListener("click", startQuizTema);
    btnSoloFalladas.addEventListener("click", startQuizFalladas);

    btnResetStats.addEventListener("click", ()=>{
      if(!confirm("¬øSeguro que quieres borrar falladas y stats guardadas?")) return;
      STORE = { wrongUids: {}, stats: { ok:0, bad:0, blank:0 } };
      saveStore();
      refreshTemaStats();
      alert("Listo: reiniciado.");
    });

    // ‚úÖ Arranque
    refreshTemaStats();
    renderScoreLine();

  } catch (err) {
    showErr("Error fatal: " + (err && err.message ? err.message : String(err)));
    if(diag){
      diag.innerHTML = `Diagn√≥stico: <b>ERROR</b>`;
    }
  }
});
</script>
</body>
</html>