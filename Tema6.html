<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<title>Derecho Civil 1 - Familia</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
:root{
  --text:#111827;
  --muted:#6b7280;
  --bd:rgba(17,24,39,.12);
  --bg:#ffffff;
  --pillbg:#f3f4f6;
  --pillbd:#e5e7eb;

  --prioBg:#eff6ff;
  --prioBd:#60a5fa;

  --ideaBg:#f5f3ff;
  --ideaBd:#a78bfa;

  --quizBg:#fff7ed;
  --quizBd:#fb923c;

  --okBg:#ecfdf5;
  --okBd:#34d399;

  --badBg:#fef2f2;
  --badBd:#f87171;

  --btnBg:#111827;
  --btnTxt:#ffffff;
  --btnBg2:#0b1220;
}

body{
  margin:0;
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
  background:var(--bg);
  color:var(--text);
}
.wrap{ max-width:1000px; margin:30px auto; padding:0 16px 60px }
h1{ margin:0 0 10px }
.small{ font-size:12px; opacity:.8; color:var(--muted) }

details{
  border:1px solid var(--bd);
  border-radius:14px;
  margin-bottom:12px;
  overflow:visible;
}
summary{
  cursor:pointer;
  padding:14px 16px;
  font-weight:800;
  list-style:none;
  display:flex;
  gap:10px;
  align-items:center;
  justify-content:space-between;
}
summary::-webkit-details-marker{ display:none }
.inner{ padding:0 16px 16px }

.sumLeft{
  display:flex;
  gap:10px;
  align-items:center;
  min-width:0;
}
.sumTitle{
  min-width:0;
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
}

.pill{
  font-size:12px;
  padding:3px 8px;
  border-radius:999px;
  background:var(--pillbg);
  border:1px solid var(--pillbd);
  font-weight:800;
  white-space:nowrap;
}

.tag{
  font-size:11px;
  text-transform:uppercase;
  font-weight:800;
  letter-spacing:.1em;
  margin-bottom:6px;
}

/* CAJAS */
.prio{
  background:var(--prioBg);
  border-left:5px solid var(--prioBd);
  padding:14px;
  border-radius:12px;
  margin-top:14px;
}
.prio p{ margin:8px 0; }
.prio p.li{ display:flex; gap:10px; margin:6px 0; }
.prio .liNum{ min-width:2.2em; font-weight:700; }

.idea{
  background:var(--ideaBg);
  border-left:5px solid var(--ideaBd);
  padding:14px;
  border-radius:12px;
  margin-top:14px;
  font-weight:650;
}

.quizBox{
  background:var(--quizBg);
  border-left:5px solid var(--quizBd);
  padding:14px;
  border-radius:12px;
  margin-top:14px;
}

.rowActions{
  display:flex;
  gap:10px;
  align-items:center;
  flex-wrap:wrap;
  margin-top:12px;
}

.btn{
  appearance:none;
  border:1px solid rgba(17,24,39,.15);
  background:transparent;
  padding:8px 10px;
  border-radius:10px;
  font-weight:800;
  cursor:pointer;
  color:var(--text);
}
.btn:hover{ background:rgba(17,24,39,.04) }

.btnPrimary{
  background:var(--btnBg);
  color:var(--btnTxt);
  border:1px solid rgba(17,24,39,.10);
}
.btnPrimary:hover{ background:var(--btnBg2) }

.badge{
  font-size:12px;
  font-weight:800;
  color:var(--muted);
}

p{
  margin:0 0 10px;
  line-height:1.6;
  white-space:normal;
  overflow-wrap:anywhere;
  word-break:break-word;
}

/* ===========================
   MODAL QUIZ
=========================== */
.modalOverlay{
  position:fixed;
  inset:0;
  background:rgba(17,24,39,.55);
  display:none;
  align-items:center;
  justify-content:center;
  padding:18px;
  z-index:9999;
}
.modalOverlay.show{ display:flex; }

.modal{
  width:min(860px, 100%);
  background:#fff;
  border-radius:16px;
  border:1px solid rgba(17,24,39,.12);
  box-shadow: 0 20px 60px rgba(0,0,0,.25);
  overflow:hidden;
}
.modalHeader{
  padding:14px 16px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  border-bottom:1px solid rgba(17,24,39,.10);
  background:linear-gradient(to bottom, rgba(17,24,39,.03), rgba(17,24,39,0));
}
.modalHeader .left{
  display:flex;
  gap:10px;
  align-items:center;
  min-width:0;
}
.modalHeader .title{
  font-weight:900;
  min-width:0;
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
}
.modalHeader .right{
  display:flex;
  gap:10px;
  align-items:center;
  flex-wrap:wrap;
}
.timerPill{
  font-size:12px;
  padding:3px 8px;
  border-radius:999px;
  border:1px solid rgba(17,24,39,.12);
  background:rgba(17,24,39,.04);
  font-weight:900;
}

.modalBody{ padding:16px; }
.qText{
  font-weight:900;
  font-size:16px;
  margin-bottom:12px;
}
.opts{
  display:flex;
  flex-direction:column;
  gap:10px;
}
.optBtn{
  text-align:left;
  border:1px solid rgba(17,24,39,.12);
  background:#fff;
  border-radius:12px;
  padding:12px 12px;
  cursor:pointer;
  font-weight:750;
}
.optBtn:hover{ background:rgba(17,24,39,.03) }
.optBtn .k{
  display:inline-flex;
  width:26px;
  height:26px;
  border-radius:999px;
  align-items:center;
  justify-content:center;
  margin-right:10px;
  border:1px solid rgba(17,24,39,.10);
  background:rgba(17,24,39,.04);
  font-weight:900;
}
.feedback{
  margin-top:14px;
  padding:12px;
  border-radius:12px;
  border-left:5px solid transparent;
  display:none;
}
.feedback.show{ display:block; }
.feedback.ok{ background:var(--okBg); border-left-color:var(--okBd); }
.feedback.bad{ background:var(--badBg); border-left-color:var(--badBd); }

.explicacion{
  margin-top:8px;
  font-size:13px;
  opacity:.9;
}

.modalFooter{
  padding:14px 16px;
  display:flex;
  gap:10px;
  align-items:center;
  justify-content:space-between;
  border-top:1px solid rgba(17,24,39,.10);
  flex-wrap:wrap;
}
.modalFooter .left{
  display:flex;
  gap:10px;
  align-items:center;
  flex-wrap:wrap;
}
kbd{
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
  font-size:12px;
  padding:2px 6px;
  border-radius:8px;
  border:1px solid rgba(17,24,39,.15);
  background:rgba(17,24,39,.04);
}
.scoreLine{
  font-size:12px;
  color:var(--muted);
  font-weight:800;
}

/* Caja de error visible */
.errBox{
  display:none;
  margin-top:12px;
  padding:12px;
  border-radius:12px;
  background:#fef2f2;
  border-left:5px solid #f87171;
  color:#111827;
  font-weight:800;
}
.errBox.show{ display:block; }

/* Diagnóstico */
.diag{
  margin-top:12px;
  padding:12px;
  border:1px solid rgba(17,24,39,.12);
  border-radius:12px;
  background:rgba(17,24,39,.02);
  font-size:12px;
  color:var(--muted);
  font-weight:800;
  display:flex;
  gap:10px;
  flex-wrap:wrap;
}
.diag b{ color:#111827; }
</style>
</head>

<body>
<div class="wrap">
  <h1 id="tituloTema">Capítulo 6 – Derecho Civil 1 - Familia</h1>
  <div class="small">LA SEPARACIÓN MATRIMONIAL, by M.García</div>

  <div id="errBox" class="errBox"></div>
  <div id="diag" class="diag">Diagnóstico: <b>cargando…</b></div>

  <div class="rowActions" style="margin-top:12px">
    <button class="btn btnPrimary" id="btnTemaRandom" type="button">Realiza test por tema</button>

    <label class="badge" style="display:flex; gap:8px; align-items:center;">
      Nº preguntas
      <select id="selTemaN" class="btn" style="padding:6px 10px;">
        <option value="10">10</option>
        <option value="20" selected>20</option>
        <option value="50">50</option>
        <option value="100">100</option>
      </select>
    </label>

    <button class="btn" id="btnSoloFalladas" type="button">Solo falladas</button>
    <button class="btn" id="btnResetStats" type="button">Reiniciar stats</button>
    <span class="badge" id="badgeTemaTotal">0 preguntas cargadas</span>
  </div>

  <div id="contenido" style="margin-top:14px"></div>
</div>

<!-- MODAL -->
<div id="modalOverlay" class="modalOverlay" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="modal">
    <div class="modalHeader">
      <div class="left">
        <span id="modalPill" class="pill">—</span>
        <div class="title" id="modalTitle">Pregunta</div>
      </div>
      <div class="right">
        <span class="timerPill" id="modalTimer">00:00</span>
        <button class="btn" id="btnCloseModal" type="button">Cerrar</button>
      </div>
    </div>

    <div class="modalBody">
      <div class="qText" id="modalQuestion">—</div>
      <div class="opts" id="modalOptions"></div>

      <div id="modalFeedback" class="feedback">
        <div id="modalFeedbackTitle" style="font-weight:900"></div>
        <div class="explicacion" id="modalExplanation"></div>
      </div>
    </div>

    <div class="modalFooter">
      <div class="left">
        <button class="btn btnPrimary" id="btnNextQuestion" type="button">Siguiente</button>
        <button class="btn" id="btnBlank" type="button">Dejar en blanco</button>
        <span class="badge" id="modalCounter">0/0</span>
      </div>
      <div>
        <div class="scoreLine" id="scoreLine">Aciertos 0 · Fallos 0 · Blancos 0 · Puntos 0.00 (de 0)</div>
        <div class="small">Atajos: <kbd>Esc</kbd> cerrar · <kbd>Enter</kbd> siguiente</div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const errBox = document.getElementById("errBox");
  const diag = document.getElementById("diag");

  function showErr(msg){
    if(!errBox) return;
    errBox.textContent = msg;
    errBox.classList.add("show");
  }

  window.addEventListener("error", (e)=>{
    showErr("Error JS: " + (e.message || "desconocido"));
  });

  try{
    /* =========================
       ✅ PUNTUACIÓN (UNA SOLA VEZ)
    ========================= */
    const SCORE_OK = 0.5;
    const SCORE_BAD = 0.20;   // resta
    const SCORE_BLANK = 0;    // no suma ni resta

    /* =========================================================
       1) TEXTO BASE (tu PDF pegado)
    ========================================================= */
    const PDF_TEXTO = `
1. LA SEPARACIÓN MATRIMONIAL.
La separación matrimonial, a diferencia de la nulidad y del divorcio, no extingue el vínculo entre
los cónyuges, sino que produce únicamente la suspensión de la vida en común, conforme al
art. 83 CC. Se mantiene, por tanto, la existencia del matrimonio, aunque cesa la convivencia.
En el sistema normativo español, la separación puede producirse mediante sentencia judicial,
decreto o escritura pública con convenio regulador. Sin embargo, desde la reforma de 1981 se
reconoce también una notable relevancia jurídica a la separación de hecho, realidad social
ampliamente extendida antes y después de la Ley 30/1981. Esta opción responde a diversas
razones: preservar la intimidad de la crisis matrimonial, evitar la publicidad del proceso judicial,
facilitar soluciones rápidas y menos costosas, y, bajo el antiguo sistema causalista, permitir que
la falta de convivencia cumpliera una función cercana a la separación judicial de cara al eventual
divorcio.
La separación, tanto legal como de hecho, suele configurarse como una situación transitoria,
orientada bien a la posible reconciliación, bien al posterior divorcio —opción estadísticamente
más frecuente—, especialmente cuando uno de los cónyuges desea contraer nuevo matrimonio.
No obstante, en determinados casos puede prolongarse durante largos períodos, incluso durante
toda la vida de uno de los cónyuges, reflejando la creciente importancia de las situaciones
fácticas en las relaciones familiares.
En consecuencia, el estudio de la separación exige diferenciar entre la separación judicial y la
separación de hecho, atendiendo a su distinto fundamento y efectos dentro del sistema
matrimonial.
2. LA SEPARACIÓN JUDICIAL EN EL DERECHO VIGENTE: LA LEY 15/2005.
La denominada separación legal encontraba tradicionalmente su fundamento en las causas
previstas en el Código Civil, pues la Ley 30/1981 configuró tanto la separación como el divorcio
dentro de un sistema causalista. Con la Ley 15/2005 se abandona dicho sistema, desapareciendo
las causas legales de separación y resultando más adecuado hablar de separación judicial,
expresión utilizada en la propia Exposición de Motivos y que permite diferenciarla de la
separación de hecho.
Bajo la normativa anterior, la ley no producía automáticamente la separación, sino que
determinaba las circunstancias que permitían al juez declararla. Tales circunstancias se
concretaban en la separación por mutuo acuerdo y en las causas tasadas del antiguo art. 82 CC.
Desde 2005, la separación puede solicitarse por ambos cónyuges o por uno solo, sin necesidad
de alegar causa, si bien requiere en todo caso resolución judicial. Además, opera con
independencia de la forma de celebración del matrimonio y mantiene su carácter autónomo
respecto del divorcio, que ya no necesita ser precedido por separación.
Las reformas posteriores —Ley de Jurisdicción Voluntaria y Ley 8/2021— han introducido ajustes
competenciales y precisiones, pero no han alterado la estructura esencial del modelo instaurado
en 2005. Actualmente, cuando existan hijos menores no emancipados o mayores con medidas de
apoyo, la separación debe decretarse judicialmente, a petición de ambos cónyuges o de uno solo
una vez transcurridos tres meses desde la celebración del matrimonio.
2.1. La separación por mutuo acuerdo.
La separación por mutuo acuerdo —también denominada consensual— se basa en el
consentimiento concorde de ambos cónyuges. Puede instarse por ambos o por uno con el
consentimiento del otro, siempre que hayan transcurrido tres meses desde la celebración del
matrimonio. La demanda debe acompañarse de un convenio regulador, conforme al art. 90 CC,
que determine las medidas personales y patrimoniales derivadas de la crisis.
En el modelo de 2005, el juez debía limitarse a verificar el cumplimiento de los requisitos formales
y a homologar el acuerdo, sin entrar a valorar los motivos de la separación. No era necesario
alegar causa alguna, bastando el transcurso del plazo y la presentación del convenio.
Tras la Ley 15/2015, cuando no existan hijos menores no emancipados ni personas con medidas
de apoyo, los cónyuges pueden formalizar la separación de mutuo acuerdo mediante escritura
pública ante notario o ante el letrado de la Administración de Justicia. En tales casos deben
intervenir personalmente, asistidos por letrado, y prestar su consentimiento expreso. Si existen
hijos menores o mayores con medidas de apoyo, la competencia corresponde a la autoridad
judicial.
La sentencia, decreto o escritura pública producen la suspensión de la vida en común y el cese
de la posibilidad de vincular bienes del otro cónyuge en el ejercicio de la potestad doméstica. Los
efectos se producen desde la firmeza o desde la manifestación del consentimiento en escritura
pública, debiendo inscribirse en el Registro Civil para surtir plenos efectos frente a terceros de
buena fe.
2.2. La iniciativa de uno solo de los cónyuges.
La Ley 15/2005 introdujo una modificación sustancial al permitir que la mera voluntad de uno
solo de los cónyuges constituya fundamento suficiente para decretar judicialmente la
separación, sin necesidad de alegar ni acreditar causa alguna. Basta la decisión de no querer
continuar vinculado al otro cónyuge, eliminándose así cualquier exigencia de motivación o
exposición de conflictos personales.
Esta opción legislativa generó debate doctrinal y social, especialmente entre quienes defendían
un modelo más rígido del vínculo matrimonial. Sin embargo, desde la perspectiva jurídica, la
reforma no crea la ruptura unilateral, sino que reconoce y canaliza normativamente una realidad
social ya existente, facilitando la institucionalización jurídica de una crisis previamente producida
en el plano fáctico.
La separación a instancia de uno solo de los cónyuges exige, con carácter general, el transcurso
de tres meses desde la celebración del matrimonio, plazo que también opera en la separación
consensual. Este periodo pretende evitar decisiones precipitadas, aunque ha sido criticado por su
brevedad. No obstante, dicho plazo no es exigible cuando se acredite la existencia de riesgo para
la vida, la integridad física o moral, la libertad o la indemnidad sexual del cónyuge demandante o
de los hijos.
En los supuestos en que existan hijos menores no emancipados o mayores con medidas de
apoyo, la separación debe decretarse judicialmente. A la demanda deberá acompañarse una
propuesta fundada de las medidas que regulen los efectos derivados de la separación. Además,
como requisito de procedibilidad, debe acreditarse el intento de actividad negociadora previa,
salvo en casos excluidos legalmente —como los supuestos de violencia de género o violencia
sexual— en los que puede acudirse directamente a la vía judicial.
3. LA ACCIÓN DE SEPARACIÓN.
La acción de separación corresponde a cualquiera de los cónyuges, ya actúe individualmente o
de forma conjunta con el otro. Tras el abandono del sistema causalista por la Ley 15/2005, no es
necesario alegar ni acreditar causa alguna: basta la voluntad de separarse una vez cumplidos los
requisitos temporales y procesales exigidos por la ley.
La acción tiene carácter personalísimo, lo que implica que solo puede ser ejercitada por el
propio cónyuge legitimado y que se extingue por el fallecimiento de cualquiera de ellos, tanto si el
proceso no se ha iniciado como si se encuentra en trámite. No se transmite, por tanto, a los
herederos del cónyuge fallecido.
No obstante, este carácter personalísimo no impide que, en supuestos de discapacidad, la
acción pueda ejercitarse a través de representante legal cuando ello sea necesario para
garantizar la tutela judicial efectiva. Negar tal posibilidad supondría vulnerar el derecho
fundamental a la tutela judicial efectiva reconocido en el art. 24 CE, como ha señalado el Tribunal
Constitucional.
Mientras subsistan circunstancias que hagan aconsejable la separación, la acción puede
ejercitarse en cualquier momento, siempre que se cumpla el requisito de procedibilidad relativo a
la actividad negociadora previa exigido por la LO 1/2025, salvo en los supuestos legalmente
exceptuados.
4. LA RECONCILIACIÓN DE LOS CÓNYUGES.
La separación, ya sea de hecho o judicial, no constituye una situación irrevocable. Dado que el
vínculo matrimonial se mantiene en los supuestos de separación, la reconciliación resulta
plenamente posible en cualquier momento, bastando la voluntad de ambos cónyuges de
reanudar la convivencia. El principio general es que la reconciliación debe prevalecer sobre la
situación de separación, cualquiera que sea el estado del procedimiento.
El art. 84 CC establece que la reconciliación pone término al procedimiento de separación y deja
sin efecto lo resuelto en él. Si el proceso se encuentra en trámite, cesan las actuaciones y las
medidas provisionales adoptadas; si ya existe sentencia, esta queda sin efecto ulterior. La ley
exige que ambos cónyuges comuniquen separadamente la reconciliación al juez que esté
conociendo o haya conocido del litigio, reforzando así la autenticidad del restablecimiento de la
convivencia.
No obstante, el juez puede mantener o modificar las medidas adoptadas respecto de los hijos
cuando exista causa que lo justifique, priorizando su protección. Cuando la separación se haya
formalizado sin intervención judicial (ante notario o letrado de la Administración de Justicia), la
reconciliación deberá formalizarse en escritura pública o acta de manifestaciones y, para que
produzca efectos frente a terceros, deberá inscribirse en el Registro Civil.
La jurisprudencia ha destacado la importancia de cumplir estas exigencias formales. Mientras no
se comunique judicialmente la reconciliación o no se formalice e inscriba conforme a la ley, la
reanudación de la convivencia carece de relevancia jurídica frente a terceros, incluso en materias
como la pensión de viudedad.
5. LOS EFECTOS DE LA SEPARACIÓN.
El art. 83 CC establece que la sentencia o decreto de separación, o la escritura pública que la
determine, producen la suspensión de la vida común de los cónyuges y el cese de la
posibilidad de vincular bienes del otro en el ejercicio de la potestad doméstica. Este último
aspecto tiene carácter patrimonial y se conecta con el régimen económico matrimonial.
En el plano personal, la separación no solo implica el cese de la convivencia, sino que altera
profundamente los deberes recíprocos del art. 68 CC. Aunque el vínculo matrimonial subsiste,
desaparece el deber de vivir juntos y se debilitan los deberes de socorro mutuo y
corresponsabilidad doméstica. La doctrina admite que el deber de convivencia queda extinguido
y que el socorro mutuo se transforma, sin perjuicio de que puedan reclamarse alimentos entre
cónyuges conforme al art. 143 CC. En cuanto al deber de fidelidad, existen discrepancias
doctrinales acerca de su subsistencia durante la separación.
Respecto de los hijos, la patria potestad será ejercida conforme al art. 156 CC, normalmente por
el progenitor con quien convivan. En el ámbito sucesorio, la separación judicial priva al cónyuge
separado de sus derechos legitimarios (arts. 834 y ss. CC) y de su derecho a suceder abintestato
(art. 945 CC).
Los efectos de la separación se producen desde la firmeza de la resolución o desde el
otorgamiento de la escritura pública, pero no despliegan plenos efectos frente a terceros de
buena fe hasta su inscripción en el Registro Civil.
6. LA SEPARACIÓN DE HECHO.
La separación de hecho se diferencia de la separación judicial en que no requiere proceso ni
resolución alguna, sino que deriva exclusivamente de decisiones personales de los cónyuges que
no se someten al control judicial. Puede iniciarse por abandono unilateral del hogar o por acuerdo
de ambos para cesar la convivencia.
Tradicionalmente fue contemplada con recelo por doctrina y jurisprudencia, llegándose incluso a
cuestionar su licitud por vulnerar el deber de convivencia. Sin embargo, desde finales del siglo XX
se ha admitido plenamente su licitud como manifestación del libre desarrollo de la personalidad.
Tras la Ley 30/1981, y con mayor claridad tras la Ley 15/2005, el ordenamiento no ignora la
separación de hecho, sino que le atribuye efectos jurídicos relevantes, adaptando el régimen
matrimonial a la situación de ruptura efectiva.
6.1. La separación de hecho provocada unilateralmente.
Cuando la separación es unilateral, resulta imposible el acuerdo sobre las consecuencias de la
ruptura. Bajo el sistema causalista anterior, el cese efectivo de la convivencia constituía causa de
separación o divorcio. Aunque el sistema causalista fue abandonado, la separación de hecho
sigue produciendo efectos jurídicos de gran relevancia.
Así, la separación de hecho durante más de un año es causa suficiente para instar la disolución
judicial de la sociedad de gananciales (art. 1393.3.º). En materia de patria potestad, el art. 156.5
dispone que, si los padres viven separados, la ejercerá el progenitor con quien conviva el hijo,
pudiendo el no conviviente solicitar su ejercicio conjunto o la distribución de funciones.
En el ámbito sucesorio, la separación de hecho priva al cónyuge separado de sus derechos
legitimarios (art. 834 CC, sensu contrario) y del llamamiento en la sucesión intestada (art. 945
CC).
Por el contrario, la separación de hecho no extingue la obligación alimenticia entre cónyuges,
pues el deber de alimentos no se condiciona legalmente al mantenimiento de la convivencia, si
bien no podrá reclamar alimentos el cónyuge que haya abandonado sin justa causa.
6.2. LA SEPARACIÓN DE HECHO CONVENCIONAL.
La separación de hecho convencional produce los mismos efectos jurídicos que la separación
unilateral, pero presenta una característica propia: va acompañada normalmente de pactos entre
los cónyuges que regulan las consecuencias de la ruptura. Estos acuerdos suelen formalizarse
incluso en escritura pública ante notario.
Su contenido es amplio y heterogéneo, pero en la práctica coincide con las medidas típicas
previstas para las crisis matrimoniales: uso de la vivienda y ajuar familiar, régimen de custodia y
cuidado de los hijos, contribución a cargas familiares, alimentos y cuestiones relativas al régimen
económico matrimonial.
Durante largo tiempo se cuestionó la validez de estos pactos por entender que podían estar
afectados por causa ilícita al vulnerar el deber de convivencia. Sin embargo, tras la Constitución
de 1978 y las reformas de 1981, se consolidó doctrinalmente su plena licitud, en coherencia con
el principio de autonomía privada y la igualdad entre los cónyuges.
En la actualidad, tales pactos se consideran válidos siempre que no vulneren el orden público, no
lesionen el principio de igualdad conyugal y no resulten perjudiciales para los hijos.
`.trim();

    /* =========================================================
       2) IDEAS CLAVE (MANUAL)
    ========================================================= */
    const IDEAS_CLAVE = {

  "1": "La separación matrimonial no extingue el vínculo, sino que suspende la vida en común, pudiendo ser judicial o de hecho, y suele configurarse como situación transitoria orientada a la reconciliación o al divorcio.",

  "2": "Tras la Ley 15/2005 se abandona el sistema causalista y la separación judicial puede solicitarse sin alegar causa, manteniendo autonomía respecto del divorcio y requiriendo resolución judicial cuando existan hijos menores o personas con medidas de apoyo.",

  "2.1": "La separación por mutuo acuerdo se basa en el consentimiento concorde de los cónyuges, exige convenio regulador y puede formalizarse judicialmente o, en ausencia de hijos menores o personas con medidas de apoyo, mediante escritura pública o decreto.",

  "2.2": "La voluntad unilateral de uno solo de los cónyuges es fundamento suficiente para la separación judicial tras tres meses desde la celebración del matrimonio, sin necesidad de alegar causa, salvo supuestos de riesgo que permiten obviar el plazo.",

  "3": "La acción de separación corresponde a cualquiera de los cónyuges, tiene carácter personalísimo, no exige causa y se extingue por fallecimiento, requiriendo el cumplimiento del requisito de procedibilidad salvo supuestos exceptuados.",

  "4": "La reconciliación es siempre posible mientras subsista el vínculo matrimonial y deja sin efecto el procedimiento o la sentencia de separación, debiendo comunicarse o formalizarse conforme a la ley para producir efectos frente a terceros.",

  "5": "La separación produce la suspensión de la vida común y el cese de la potestad doméstica sobre bienes del otro cónyuge, altera los deberes conyugales y genera efectos en el ámbito patrimonial, sucesorio y respecto de los hijos.",

  "6": "La separación de hecho deriva exclusivamente de decisiones personales sin intervención judicial y, pese a su carácter fáctico, produce efectos jurídicos relevantes en los ámbitos patrimonial, sucesorio y familiar.",

  "6.1": "La separación de hecho unilateral genera efectos como la posible disolución de la sociedad de gananciales, incidencia en la patria potestad y pérdida de derechos sucesorios, sin extinguir la obligación alimenticia entre cónyuges.",

  "6.2": "La separación de hecho convencional incorpora pactos entre los cónyuges sobre las consecuencias de la ruptura, válidos en la actualidad siempre que respeten el orden público, la igualdad conyugal y el interés de los hijos."
 
    };

    /* =========================================================
       3) BANCO DE PREGUNTAS (TU BANCO ORIGINAL)
       ✅ OJO: aquí pegamos TAL CUAL tu banco (1–100)
    ========================================================= */
    
    
    const BANCO_1 = ` 
#ID = 1

// [1]
Q: ¿Cuál es la consecuencia jurídica esencial de la separación matrimonial conforme al art. 83 CC?
A) La disolución definitiva del vínculo conyugal.
B) La suspensión de la vida en común manteniéndose la existencia del matrimonio.
C) La extinción automática del régimen económico matrimonial.
OK: B
EXP: La separación no extingue el matrimonio; suspende la convivencia manteniendo el vínculo jurídico.

// [2]
Q: ¿En qué se diferencia estructuralmente la separación del divorcio?
A) En que la separación exige siempre acuerdo mutuo.
B) En que el divorcio extingue el vínculo y la separación no.
C) En que la separación carece de efectos patrimoniales.
OK: B
EXP: El divorcio disuelve el matrimonio; la separación solo altera la convivencia.

// [3]
Q: ¿Qué elemento permite diferenciar técnicamente la separación judicial de la separación de hecho?
A) La duración mínima exigida.
B) La intervención de una autoridad con resolución formal.
C) La necesidad de convenio regulador.
OK: B
EXP: La separación judicial requiere sentencia, decreto o escritura pública; la de hecho nace de una situación fáctica.

// [4]
Q: ¿Por qué la separación suele configurarse como una situación transitoria?
A) Porque la ley fija un plazo máximo de duración.
B) Porque suele preceder a reconciliación o divorcio.
C) Porque extingue todos los deberes conyugales.
OK: B
EXP: Estadísticamente la separación opera como fase intermedia hacia reconciliación o divorcio.



#ID = 2.1

// [5]
Q: ¿Qué requisito estructural exige la separación consensual conforme al art. 90 CC?
A) La acreditación de causa grave.
B) La presentación de un convenio regulador que ordene los efectos de la crisis.
C) La previa separación de hecho durante un año.
OK: B
EXP: El convenio regulador articula las medidas personales y patrimoniales derivadas de la separación.

// [6]
Q: ¿Cuál es el presupuesto temporal general para instar la separación por mutuo acuerdo?
A) Un año desde la celebración del matrimonio.
B) Tres meses desde la celebración del matrimonio.
C) Seis meses de convivencia efectiva.
OK: B
EXP: La ley establece un plazo mínimo de tres meses como periodo de reflexión.

// [7]
Q: ¿Cuándo puede formalizarse la separación consensual ante notario o Letrado de la Administración de Justicia?
A) Siempre que exista acuerdo entre los cónyuges.
B) Cuando no existan hijos menores no emancipados ni mayores con medidas de apoyo.
C) Cuando el matrimonio se haya celebrado civilmente.
OK: B
EXP: Si existen hijos menores o personas con medidas de apoyo, la competencia corresponde al juez.

// [8]
Q: ¿Desde cuándo producen efectos la sentencia, decreto o escritura pública de separación?
A) Desde la presentación de la demanda.
B) Desde la firmeza o desde la manifestación del consentimiento en escritura pública.
C) Desde la inscripción registral exclusivamente.
OK: B
EXP: Los efectos nacen desde la firmeza o desde el otorgamiento; la inscripción es necesaria frente a terceros de buena fe.



#ID = 2.2

// [9]
Q: ¿Qué innovación fundamental introduce la Ley 15/2005 respecto a la separación solicitada por uno solo de los cónyuges?
A) La necesidad de mediación obligatoria.
B) La supresión del requisito de alegar causa.
C) La exigencia de autorización judicial previa.
OK: B
EXP: Basta la voluntad unilateral sin necesidad de acreditar incumplimiento o causa tasada.

// [10]
Q: ¿Cuál es el fundamento jurídico suficiente para que se decrete la separación unilateral?
A) La mera decisión de no continuar la convivencia conyugal.
B) La prueba de culpa del otro cónyuge.
C) La existencia de ruptura económica.
OK: A
EXP: El sistema actual reconoce la voluntad individual como base suficiente de la separación.

// [11]
Q: ¿En qué supuesto no resulta exigible el plazo general de tres meses?
A) Cuando exista riesgo para la vida, integridad o libertad del cónyuge o de los hijos.
B) Cuando ambos cónyuges estén de acuerdo.
C) Cuando el matrimonio sea de corta duración.
OK: A
EXP: La ley exceptúa el plazo en situaciones de riesgo grave.

// [12]
Q: ¿Qué requisito procesal adicional puede exigirse en la separación instada unilateralmente tras la LO 1/2025?
A) Acreditar intento previo de actividad negociadora, salvo supuestos exceptuados.
B) Presentar informe psicológico obligatorio.
C) Solicitar autorización del Ministerio Fiscal.
OK: A
EXP: La actividad negociadora previa constituye requisito de procedibilidad salvo en casos de violencia o exclusión legal.
    `;


    const BANCO_2 = ` 
#ID = 3

// [13]
Q: ¿Qué característica define jurídicamente la acción de separación tras la reforma de 2005?
A) Su carácter necesariamente consensual.
B) Su desvinculación de cualquier sistema causal.
C) Su subordinación a la previa nulidad del matrimonio.
OK: B
EXP: Tras la Ley 15/2005 la separación ya no exige alegar ni probar causa alguna.

// [14]
Q: ¿Qué significa que la acción de separación tenga carácter personalísimo?
A) Que puede ejercitarla cualquier persona con interés legítimo.
B) Que solo puede ejercitarla el propio cónyuge legitimado y no se transmite mortis causa.
C) Que requiere intervención obligatoria del Ministerio Fiscal.
OK: B
EXP: La acción corresponde exclusivamente al cónyuge y se extingue con su fallecimiento.

// [15]
Q: ¿Cómo se garantiza el ejercicio de la acción de separación cuando uno de los cónyuges tiene discapacidad?
A) Mediante sustitución automática por el Ministerio Fiscal.
B) A través de representante legal cuando sea necesario para asegurar tutela judicial efectiva.
C) Mediante autorización administrativa previa.
OK: B
EXP: El Tribunal Constitucional ha vinculado esta posibilidad al derecho del art. 24 CE.

// [16]
Q: ¿Cuándo puede ejercitarse la acción de separación conforme al sistema vigente?
A) Solo dentro del año siguiente a la crisis.
B) En cualquier momento mientras subsistan las circunstancias que la aconsejen y se cumplan requisitos legales.
C) Únicamente si existe incumplimiento grave de deberes conyugales.
OK: B
EXP: No existe plazo máximo general, salvo el cumplimiento del plazo mínimo inicial.

// [17]
Q: ¿Qué papel cumple el requisito de actividad negociadora previa introducido por la LO 1/2025?
A) Sustituye el procedimiento judicial.
B) Actúa como requisito de procedibilidad antes de admitir la demanda.
C) Obliga a alcanzar acuerdo entre las partes.
OK: B
EXP: La acreditación del intento negociador es condición procesal salvo excepciones legales.



#ID = 4

// [18]
Q: ¿Qué efecto produce la reconciliación respecto del procedimiento de separación en curso?
A) Lo transforma automáticamente en divorcio.
B) Pone término al procedimiento y deja sin efecto lo resuelto.
C) Suspende únicamente las medidas patrimoniales.
OK: B
EXP: El art. 84 CC establece que la reconciliación extingue el proceso y sus efectos.

// [19]
Q: ¿Qué requisito formal exige la ley para que la reconciliación tenga plena eficacia jurídica?
A) Manifestación privada entre los cónyuges.
B) Comunicación separada al juez o formalización en escritura pública si no hubo intervención judicial.
C) Inscripción automática sin formalidad previa.
OK: B
EXP: La comunicación formal garantiza seguridad jurídica y oponibilidad.

// [20]
Q: ¿Puede el juez mantener medidas relativas a los hijos pese a la reconciliación?
A) No, deben cesar automáticamente.
B) Sí, cuando exista causa que lo justifique en protección de los menores.
C) Solo si lo solicita el Ministerio Fiscal.
OK: B
EXP: La protección del interés del menor prevalece sobre la autonomía de los cónyuges.

// [21]
Q: ¿Qué ocurre si la reconciliación no se comunica formalmente?
A) Carece de toda validez entre los cónyuges.
B) No produce efectos frente a terceros de buena fe.
C) Se considera inexistente el matrimonio.
OK: B
EXP: Sin formalización e inscripción, la reconciliación no despliega eficacia frente a terceros.

// [22]
Q: ¿Por qué la reconciliación es jurídicamente posible en la separación pero no en el divorcio?
A) Porque en la separación subsiste el vínculo matrimonial.
B) Porque el divorcio exige autorización administrativa.
C) Porque la reconciliación solo tiene efectos simbólicos.
OK: A
EXP: La separación no extingue el matrimonio; el divorcio sí lo disuelve definitivamente.
    `;


    const BANCO_3 = ` 
#ID = 5

// [23]
Q: ¿Cuál es el efecto nuclear que produce la separación conforme al art. 83 CC?
A) La disolución del vínculo matrimonial.
B) La suspensión de la vida en común manteniéndose el vínculo.
C) La conversión automática en divorcio tras un plazo legal.
OK: B
EXP: La separación no extingue el vínculo, sino que suspende la convivencia y altera determinados efectos personales y patrimoniales.

// [24]
Q: ¿Qué consecuencia patrimonial inmediata genera la separación respecto a la potestad doméstica?
A) Se mantiene sin limitaciones.
B) Se extingue la sociedad de gananciales automáticamente.
C) Cesa la posibilidad de vincular bienes del otro cónyuge por actos de potestad doméstica.
OK: C
EXP: El art. 83 CC establece el cese de la facultad de vinculación patrimonial unilateral derivada de la potestad doméstica.

// [25]
Q: ¿Cómo afecta la separación al deber de convivencia del art. 68 CC?
A) Se mantiene plenamente vigente.
B) Queda suspendido, pues desaparece la obligación de vivir juntos.
C) Solo se atenúa parcialmente.
OK: B
EXP: La separación implica precisamente el cese de la vida común, por lo que el deber de convivencia deja de ser exigible.

// [26]
Q: ¿Desaparece completamente el deber de socorro mutuo tras la separación?
A) Sí, queda totalmente extinguido.
B) No, puede transformarse en obligación alimenticia conforme al art. 143 CC.
C) Solo subsiste si hay hijos comunes.
OK: B
EXP: Aunque se debilitan los deberes conyugales, pueden mantenerse obligaciones de alimentos entre cónyuges.

// [27]
Q: ¿Qué efecto produce la separación judicial en el ámbito sucesorio?
A) Ninguno, el cónyuge conserva todos sus derechos.
B) Priva al cónyuge separado de derechos legitimarios y de la sucesión intestada.
C) Solo afecta a la legítima, no a la sucesión abintestato.
OK: B
EXP: Los arts. 834 y 945 CC excluyen al cónyuge judicialmente separado de derechos sucesorios.

// [28]
Q: ¿Desde cuándo producen efectos jurídicos la sentencia o escritura de separación?
A) Desde su inscripción registral.
B) Desde la firmeza de la resolución o el otorgamiento de la escritura.
C) Desde la presentación de la demanda.
OK: B
EXP: Los efectos nacen desde la firmeza o el otorgamiento, aunque frente a terceros requieren inscripción.

// [29]
Q: ¿Qué función cumple la inscripción de la separación en el Registro Civil?
A) Constituye el estado civil de separado.
B) Permite la producción de efectos frente a terceros de buena fe.
C) Es meramente decorativa.
OK: B
EXP: La inscripción no crea la separación, pero condiciona su eficacia frente a terceros.

// [30]
Q: ¿Cómo se ejerce la patria potestad tras la separación?
A) Se extingue automáticamente.
B) Se atribuye exclusivamente al progenitor custodio.
C) Se ejerce conforme al art. 156 CC, normalmente por quien conviva con el menor.
OK: C
EXP: El ejercicio se adapta a la situación de convivencia, pudiendo mantenerse el ejercicio conjunto según las circunstancias.

// [31]
Q: ¿Qué ocurre con el deber de fidelidad tras la separación?
A) Se mantiene con idéntico alcance que en el matrimonio convivencial.
B) Existe debate doctrinal sobre su subsistencia durante la separación.
C) Se transforma en obligación indemnizatoria automática.
OK: B
EXP: La doctrina discrepa sobre su mantenimiento pleno durante la separación, al no existir convivencia.

// [32]
Q: ¿Puede la separación afectar al régimen económico matrimonial?
A) No, el régimen permanece inalterado.
B) Solo si lo acuerdan los cónyuges.
C) Sí, puede incidir en la administración y en la vinculación de bienes.
OK: C
EXP: La suspensión de la potestad doméstica y otras medidas pueden alterar el funcionamiento práctico del régimen económico.

// [33]
Q: ¿Qué rasgo define estructuralmente la separación frente al divorcio?
A) La posibilidad de contraer nuevo matrimonio.
B) La extinción definitiva del vínculo.
C) La subsistencia del vínculo matrimonial.
OK: C
EXP: A diferencia del divorcio, la separación mantiene vivo el vínculo jurídico entre los cónyuges.
   `;


    const BANCO_4 = ` 
#ID = 6

// ==================================================
// EPÍGRAFE 6 — LA SEPARACIÓN DE HECHO
// (Preguntas 34–36)
// ==================================================

// [34]
Q: ¿Qué rasgo define jurídicamente la separación de hecho frente a la separación judicial?
A) Exige siempre una resolución judicial firme para existir.
B) Nace de la decisión fáctica de los cónyuges sin necesidad de proceso ni resolución.
C) Solo existe si se inscribe previamente en el Registro Civil.
OK: B
EXP: La separación de hecho se produce por la ruptura efectiva de la convivencia sin control judicial, aunque el ordenamiento le reconoce efectos jurídicos relevantes.

// [35]
Q: ¿Por qué el ordenamiento contemporáneo ha terminado por admitir la licitud de la separación de hecho?
A) Porque elimina automáticamente los deberes conyugales y el vínculo matrimonial.
B) Porque se considera manifestación del libre desarrollo de la personalidad.
C) Porque siempre va acompañada de un convenio regulador homologado.
OK: B
EXP: La evolución doctrinal y jurisprudencial ha pasado de ver la separación fáctica como infracción del deber de convivencia a admitirla como decisión personal legítima.

// [36]
Q: ¿Qué explica que el Derecho atribuya efectos a la separación de hecho pese a no requerir formalización?
A) La necesidad de adaptar el régimen matrimonial a la ruptura real de la convivencia.
B) La exigencia legal de publicidad registral de toda crisis matrimonial.
C) La conversión automática en separación judicial transcurrido un año.
OK: A
EXP: El sistema no ignora la ruptura efectiva: atribuye consecuencias patrimoniales, sucesorias y familiares para ordenar situaciones ya producidas en la realidad.


#ID = 6.1

// [37]
Q: ¿Qué efecto patrimonial específico permite la separación de hecho unilateral mantenida durante más de un año?
A) La nulidad del matrimonio por ausencia de convivencia.
B) La disolución judicial de la sociedad de gananciales.
C) La extinción automática de toda obligación alimenticia entre cónyuges.
OK: B
EXP: La separación de hecho prolongada puede fundamentar la solicitud de disolución judicial de la sociedad de gananciales (art. 1393.3.º CC).

// [38]
Q: Si los progenitores viven separados de hecho, ¿qué regla general fija el art. 156.5 CC sobre el ejercicio de la patria potestad?
A) La pierde el progenitor no conviviente salvo sentencia.
B) La ejerce el progenitor con quien conviva el hijo, sin perjuicio de pedir ejercicio conjunto o distribución.
C) Debe ejercerse siempre de forma conjunta y simultánea.
OK: B
EXP: La norma parte de un criterio funcional ligado a la convivencia efectiva, permitiendo al no conviviente solicitar ajustes (ejercicio conjunto o reparto).

// [39]
Q: ¿Qué efecto sucesorio puede producir la separación de hecho respecto del cónyuge separado?
A) Mantiene intactos sus derechos legitimarios y abintestato.
B) Puede privarle de derechos legitimarios y del llamamiento en la sucesión intestada.
C) Solo afecta a la sucesión testada, no a la intestada.
OK: B
EXP: El texto vincula la separación de hecho a consecuencias sucesorias: pérdida de derechos legitimarios (art. 834 CC, sensu contrario) y del llamamiento abintestato (art. 945 CC).

#ID = 6.2

// [40]
Q: ¿Qué requisito condiciona la validez de los pactos propios de la separación de hecho convencional?
A) Que se homologuen judicialmente en todo caso.
B) Que no vulneren el orden público, no lesionen la igualdad conyugal y no perjudiquen a los hijos.
C) Que incluyan siempre renuncia recíproca a alimentos.
OK: B
EXP: Los acuerdos son lícitos como expresión de autonomía privada, pero quedan sometidos a límites: orden público, igualdad y protección de los hijos.
    `;


    const BANCO_5 = ` 
pega texto aqui
    `;
    
    

    const BANCO_TEXTO = [BANCO_1, BANCO_2, BANCO_3, BANCO_4, BANCO_5]
      .map(s => String(s || "").trim())
      .filter(Boolean)
      .join("\n\n");

    /* =========================
       HELPERS
    ========================= */
    function escapeHtml(s){
      return String(s ?? "")
        .replace(/&/g,"&amp;")
        .replace(/</g,"&lt;")
        .replace(/>/g,"&gt;")
        .replace(/"/g,"&quot;")
        .replace(/'/g,"&#039;");
    }
    
    function quitarTituloRepetidoSeguro(texto, titulo){
  const t0 = String(texto || "");
  const h0 = String(titulo || "");
  if(!t0.trim() || !h0.trim()) return t0.trim();

  // Normaliza: minúsculas + espacios raros (NBSP) + BOM
  const clean = s => String(s)
    .replace(/^\uFEFF/, "")          // BOM
    .replace(/\u00A0/g, " ")         // NBSP -> espacio normal
    .replace(/\s+/g, " ")
    .trim()
    .toLowerCase();

  const t = clean(t0);
  const h = clean(h0);

  if(!t.startsWith(h)) return t0.trim();

  // Corta del texto ORIGINAL, pero usando la longitud del título ORIGINAL
  // (buscamos el match real al principio ignorando mayúsculas y espacios raros)
  const re = new RegExp(
    "^\\s*" + h0.trim()
      .replace(/[.*+?^${}()|[\]\\]/g, "\\$&")   // escape regex
      .replace(/\s+/g, "[\\s\\u00A0]+")         // admite NBSP
    + "[\\s\\u00A0]+",
    "i"
  );

  return t0.replace(re, "").trim();
}




function formatearParrafos(t){
  const BUL = "[-\\u2010\\u2011\\u2012\\u2013\\u2014\\u2212\\u2022]"; // -, ‐, -, ‒, –, —, −, •
  const WS  = "[\\s\\u00A0\\u2000-\\u200A\\u202F\\u205F\\u3000]+";   // espacios raros PDF incluidos

  // 1) Normaliza espacios “raros” y saltos
  let raw = String(t ?? "")
    .replace(/\r/g,"")
    .replace(/[\u00A0\u2000-\u200A\u202F\u205F\u3000]/g, " "); // NBSP/EMSP/etc -> espacio normal

  // 2) ✅ Inserta saltos antes de enumeraciones internas "1) 2) 3)"
  // Caso típico: "puede ser: 1) ... 2) ... 3) ..."
  raw = raw
    // después de : ; . ! ? -> salto + "n)"
    .replace(/([:;.!?])\s*(\d+\)\s+)/g, "$1\n$2")
    // si vienen encadenadas sin puntuación clara pero con mucho espacio: " ...  2) ..."
    .replace(/(\s{2,})(\d+\)\s+)/g, "\n$2");

  const lines = raw
    .split("\n")
    .map(l => l.replace(/\s+$/,"")); // trimEnd

  const connectors = /^(Además|En consecuencia|No obstante|Sin embargo|Asimismo|Por tanto|Por ello|Finalmente|En cambio|De hecho|Ahora bien|Por otro lado|En efecto|Así,?|En primer lugar|En segundo lugar)\b/i;

  const isNumParenItem = (s) => /^\d+\)\s+/.test(s.trimStart());
  const isLetterItem   = (s) => /^[a-z]\)\s+/i.test(s.trimStart());
  const isBullet       = (s) => new RegExp("^" + BUL + WS).test(s.trimStart());

  const isListOrHeading = (s) =>
    new RegExp("^(\\d+(?:\\.\\d+)*\\.|\\d+\\)|" + BUL + "|[a-z]\\))" + WS).test(s.trimStart());

  const splitBulletAtFirstSentence = (s) => {
    if(!isBullet(s)) return null;
    const m = s.match(new RegExp("([.!?])" + WS));
    if(!m) return null;
    const idx = s.search(new RegExp("([.!?])" + WS));
    const cut = idx + 1;
    const left  = s.slice(0, cut).trim();
    const right = s.slice(cut).replace(new RegExp("^" + WS), "").trim();
    if(!right) return null;
    return { left, right };
  };

  const paras = [];
  let current = "";

  const flush = () => {
    if(current.trim()) paras.push(current.trim());
    current = "";
  };

  for (let i=0; i<lines.length; i++){
    const line = lines[i].trimStart();

    if(!line.trim()){
      flush();
      continue;
    }

    if(isListOrHeading(line)){
      flush();

      // a) b) c)
      if(isLetterItem(line)){
        paras.push(line.trim());
        current = "";
        continue;
      }

      // 1) 2) 3) -> línea propia
      if(isNumParenItem(line)){
        paras.push(line.trim());
        current = "";
        continue;
      }

      // viñeta
      if(isBullet(line)){
        const sp = splitBulletAtFirstSentence(line);
        if(sp){
          paras.push(sp.left);
          current = sp.right;
        }else{
          paras.push(line.trim());
          current = "";
        }
        continue;
      }

      current = line.trim();
      continue;
    }

    if(current && /[.!?]$/.test(current) && connectors.test(line.trim())){
      flush();
      current = line.trim();
      continue;
    }

    current += (current ? " " : "") + line.trim();
  }

  flush();

  // Render: si es "1) ..." lo pintamos como bloque tipo lista (sangría real)
  return paras.map(p => {
    const s = String(p);
    const m = s.match(/^(\d+)\)\s+([\s\S]+)$/);
    if(m){
      return `<p class="li"><span class="liNum">${escapeHtml(m[1])})</span>${escapeHtml(m[2])}</p>`;
    }
    return `<p>${escapeHtml(s)}</p>`;
  }).join("");
}

    // Jerarquía epígrafes
    function esDescendiente(idHijo, idPadre){
      return String(idHijo).startsWith(String(idPadre) + ".");
    }
    function parentId(id){
      const parts = String(id || "").split(".");
      if(parts.length <= 1) return null;
      parts.pop();
      return parts.join(".");
    }


    // Jerarquía epígrafes
    function esDescendiente(idHijo, idPadre){
      return String(idHijo).startsWith(String(idPadre) + ".");
    }
    function parentId(id){
      const parts = String(id || "").split(".");
      if(parts.length <= 1) return null;
      parts.pop();
      return parts.join(".");
    }

    /* =========================
       PDF -> epígrafes
    ========================= */
    function extraerEncabezados(){
      // Soporta: "1. TÍTULO" y "1.1. TÍTULO"
      const re = /^\s*(\d+(?:\.\d+)*)\.\s+(.+?)\s*$/;
      const lines = String(PDF_TEXTO).replace(/\r/g,"").split("\n");
      const out = [];
      for(const l of lines){
        const m = l.match(re);
        if(!m) continue;
        out.push({ id:m[1], titulo:`${m[1]}. ${m[2].trim()}` });
      }
      return out;
    }

    function textoPorId(id){
      if(!id) return "";
      const safe = id.replace(/\./g,"\\.");
      const reStart = new RegExp(`(^|\\n)${safe}\\.\\s+`, "m");
      const full = String(PDF_TEXTO);
      const m = full.match(reStart);
      if(!m) return "";
      const startIdx = full.indexOf(m[0]) + m[0].length;
      const rest = full.slice(startIdx);
      const nextIdx = rest.search(/\n\s*\d+(?:\.\d+)*\.\s+/);
      const chunk = (nextIdx === -1 ? rest : rest.slice(0, nextIdx)).trim();
      return chunk;
    }
    
    
       
    function normalizeKey(s){
  return String(s || "")
    .toLowerCase()
    .normalize("NFD").replace(/[\u0300-\u036f]/g,"")  // quita tildes
    .replace(/\s+/g," ")
    .replace(/[^\p{L}\p{N} ]/gu,"")                   // quita signos raros
    .trim();
}

    /* =========================
       PARSER banco
    ========================= */
    function parseBanco(texto){
      const t = String(texto || "").replace(/\r/g, "");
      const bloques = t.split(/\n(?=#ID\s*=\s*)/g).map(x=>x.trim()).filter(Boolean);
      const QUIZ = {};
      for(const bloque of bloques){
        const mId = bloque.match(/^#ID\s*=\s*([0-9]+(?:\.[0-9]+)*)\s*$/m);
        if(!mId) continue;
        const id = mId[1];

        const sinHeader = bloque.replace(/^#ID\s*=\s*[0-9]+(?:\.[0-9]+)*\s*$/m, "").trim();
        const partesQ = sinHeader.split(/\n(?=Q:\s*)/g).map(x=>x.trim()).filter(Boolean);

        const preguntas = [];
        for(const pq of partesQ){
          // ✅ acepta: // [1]  o  // N: 1
          const nMatch = pq.match(/^\/\/\s*(?:N:|\[)\s*([0-9]{1,3})\s*\]?\s*$/m);
          const qMatch = pq.match(/^Q:\s*(.+)$/m);
          if(!qMatch) continue;

          const aMatch = pq.match(/^A\)\s*(.+)$/m);
          const bMatch = pq.match(/^B\)\s*(.+)$/m);
          const cMatch = pq.match(/^C\)\s*(.+)$/m);
          const okMatch = pq.match(/^OK:\s*([ABC])\s*$/m);
          const expMatch = pq.match(/^EXP:\s*([\s\S]+)$/m);

          if(!aMatch || !bMatch || !cMatch || !okMatch) continue;

          const preguntaTxt = qMatch[1].trim();
          const uid = `${id}::${normalizeKey(preguntaTxt)}`;

          preguntas.push({
            __id: id,
            __uid: uid,
            __n: nMatch ? Number(nMatch[1]) : null,
            pregunta: preguntaTxt,
            a: aMatch[1].trim(),
            b: bMatch[1].trim(),
            c: cMatch[1].trim(),
            correcta: okMatch[1].toLowerCase(),
            explicacion: expMatch ? expMatch[1].trim() : ""
          });
        }

        if(!QUIZ[id]) QUIZ[id] = [];
        QUIZ[id].push(...preguntas);
      }
      return QUIZ;
    }

    const QUIZ = parseBanco(BANCO_TEXTO);

    function buildTemaPool(QUIZ){
      const pool = [];
      for(const id of Object.keys(QUIZ || {})){
        const list = QUIZ[id];
        if(Array.isArray(list)) pool.push(...list);
      }
      return pool;
    }
    let TEMA_POOL = buildTemaPool(QUIZ);

    /* =========================
       STORAGE
    ========================= */
    const STORAGE_KEY = "DA_TEMA2_STATS_V1";
    function loadStore(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return { wrongUids: {}, stats: { ok:0, bad:0, blank:0 } };
        const parsed = JSON.parse(raw);
        return {
          wrongUids: parsed.wrongUids || {},
          stats: parsed.stats || { ok:0, bad:0, blank:0 }
        };
      }catch{
        return { wrongUids: {}, stats: { ok:0, bad:0, blank:0 } };
      }
    }
    function saveStore(){
      try{
        localStorage.setItem(STORAGE_KEY, JSON.stringify(STORE));
      }catch{}
    }
    let STORE = loadStore();

    function markWrong(uid){ STORE.wrongUids[uid] = true; saveStore(); }
    function clearWrong(uid){ delete STORE.wrongUids[uid]; saveStore(); }
    function isWrong(uid){ return !!STORE.wrongUids[uid]; }

    /* =========================
       DOM refs
    ========================= */
    const modalOverlay = document.getElementById("modalOverlay");
    const btnCloseModal = document.getElementById("btnCloseModal");
    const btnNextQuestion = document.getElementById("btnNextQuestion");
    const btnBlank = document.getElementById("btnBlank");

    const modalPill = document.getElementById("modalPill");
    const modalTitle = document.getElementById("modalTitle");
    const modalQuestion = document.getElementById("modalQuestion");
    const modalOptions = document.getElementById("modalOptions");
    const modalFeedback = document.getElementById("modalFeedback");
    const modalFeedbackTitle = document.getElementById("modalFeedbackTitle");
    const modalExplanation = document.getElementById("modalExplanation");
    const modalCounter = document.getElementById("modalCounter");
    const scoreLine = document.getElementById("scoreLine");
    const modalTimer = document.getElementById("modalTimer");

    const btnTemaRandom = document.getElementById("btnTemaRandom");
    const selTemaN = document.getElementById("selTemaN");
    const btnSoloFalladas = document.getElementById("btnSoloFalladas");
    const btnResetStats = document.getElementById("btnResetStats");
    const badgeTemaTotal = document.getElementById("badgeTemaTotal");

    /* =========================
       ESTADO QUIZ
    ========================= */
    let currentMode = "epigrafe";
    let currentId = null;
    let deck = [];
    let idx = 0;
    let currentQ = null;
    let answered = false;

    let ses_ok = 0, ses_bad = 0, ses_blank = 0;

    function computeUNEDGrade(){
      const total = ses_ok + ses_bad + ses_blank;
      const puntos =
        (ses_ok * SCORE_OK) -
        (ses_bad * SCORE_BAD) +
        (ses_blank * SCORE_BLANK);
      return { puntos, total };
    }
    function renderScoreLine(){
      const { puntos, total } = computeUNEDGrade();
      scoreLine.textContent =
        `Aciertos ${ses_ok} · Fallos ${ses_bad} · Blancos ${ses_blank} · Puntos ${puntos.toFixed(2)} (de ${total})`;
    }

    /* =========================
       TIMER
    ========================= */
    let timerStart = 0;
    let timerHandle = null;

    function shuffle(arr){
      const a = arr.slice();
      for(let i=a.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [a[i],a[j]] = [a[j],a[i]];
      }
      return a;
    }
    function fmtTime(ms){
      const s = Math.floor(ms/1000);
      const mm = String(Math.floor(s/60)).padStart(2,"0");
      const ss = String(s%60).padStart(2,"0");
      return `${mm}:${ss}`;
    }
    function stopTimer(){
      if(timerHandle){
        clearInterval(timerHandle);
        timerHandle = null;
      }
    }
    function startTimer(){
      stopTimer();
      timerStart = Date.now();
      timerHandle = setInterval(()=>{
        modalTimer.textContent = fmtTime(Date.now() - timerStart);
      }, 250);
    }
    function openModal(){
      modalOverlay.classList.add("show");
      modalOverlay.setAttribute("aria-hidden","false");
      startTimer();
    }
    function closeModal(){
      modalOverlay.classList.remove("show");
      modalOverlay.setAttribute("aria-hidden","true");
      stopTimer();

      currentMode = "epigrafe";
      currentId = null;
      deck = [];
      idx = 0;
      currentQ = null;
      answered = false;

      modalOptions.innerHTML = "";
      modalFeedback.className = "feedback";
      modalFeedback.classList.remove("show");
      modalQuestion.textContent = "—";
      modalCounter.textContent = "0/0";
      modalTimer.textContent = "00:00";
    }

    function setFeedback(kind, title, explanation){
      modalFeedback.classList.remove("ok","bad");
      modalFeedback.classList.add(kind);
      modalFeedbackTitle.textContent = title;
      modalExplanation.textContent = explanation ? explanation : "";
      modalFeedback.classList.add("show");
    }

    /* =========================
       DECK BUILDERS
    ========================= */
    function buildDeckForEpigrafe(id){
      const list = Array.isArray(QUIZ[id]) ? QUIZ[id] : [];
      return shuffle(list);
    }
    function buildDeckForTema(n){
      const pool = TEMA_POOL.slice();
      const barajado = shuffle(pool);
      const wanted = Math.max(1, Math.min(Number(n || 20), barajado.length));
      return barajado.slice(0, wanted);
    }
    function buildDeckForFalladas(){
      const pool = TEMA_POOL.filter(q => isWrong(q.__uid));
      return shuffle(pool);
    }

    function getNextFromDeck(){
      if(!deck.length) return null;
      if(idx >= deck.length){
        if(currentMode === "tema") return null;
        deck = shuffle(deck);
        idx = 0;
      }
      const q = deck[idx];
      idx += 1;
      return q;
    }

    /* =========================
       RENDER PREGUNTA
    ========================= */
    function renderQuestion(){
      const q = getNextFromDeck();
      if(!q){
        alert("Fin del test.");
        closeModal();
        return;
      }

      currentQ = q;
      answered = false;
      modalFeedback.className = "feedback";
      modalFeedback.classList.remove("show");

      modalPill.textContent = q.__id || currentId || "—";
      modalTitle.textContent =
        currentMode === "tema" ? "Modo tema (aleatorio)" :
        currentMode === "falladas" ? "Solo falladas" :
        "Por epígrafe";

      modalQuestion.textContent = q.pregunta;
      modalCounter.textContent = `${Math.min(idx, deck.length)}/${deck.length}`;

      let opts = [
        { label:"A", text:q.a, isCorrect: q.correcta === "a" },
        { label:"B", text:q.b, isCorrect: q.correcta === "b" },
        { label:"C", text:q.c, isCorrect: q.correcta === "c" },
      ];
      opts = shuffle(opts);

      modalOptions.innerHTML = opts.map(o=>`
        <button class="optBtn" type="button" data-correct="${o.isCorrect ? "1" : "0"}">
          <span class="k">${o.label}</span>${escapeHtml(o.text)}
        </button>
      `).join("");

      [...modalOptions.querySelectorAll(".optBtn")].forEach(btn=>{
        btn.addEventListener("click", ()=>{
          if(answered) return;
          answered = true;

          const chosenCorrect = btn.getAttribute("data-correct") === "1";

          if(chosenCorrect){
            ses_ok += 1;
            clearWrong(q.__uid);
            setFeedback("ok", "Correcto ✅", q.explicacion);
          }else{
            ses_bad += 1;
            markWrong(q.__uid);
            const correctLabel = (q.correcta || "").toUpperCase();
            setFeedback("bad", `Incorrecto ❌ (Correcta: ${correctLabel})`, q.explicacion);
          }

          renderScoreLine();
          refreshTemaStats();
        });
      });
    }

    /* =========================
       START MODOS
    ========================= */
    function startQuizForId(id){
      const list = Array.isArray(QUIZ[id]) ? QUIZ[id] : [];
      if(!list.length){
        alert(`No hay preguntas cargadas para el epígrafe ${id}.`);
        return;
      }
      currentMode = "epigrafe";
      currentId = id;
      deck = buildDeckForEpigrafe(id);
      idx = 0;
      ses_ok = 0; ses_bad = 0; ses_blank = 0;
      renderScoreLine();
      openModal();
      renderQuestion();
    }

    function startQuizTema(){
      if(!TEMA_POOL.length){
        alert("No hay preguntas cargadas en el tema todavía.");
        return;
      }
      const n = selTemaN ? Number(selTemaN.value) : 20;
      currentMode = "tema";
      currentId = "TEMA";
      deck = buildDeckForTema(n);
      idx = 0;
      ses_ok = 0; ses_bad = 0; ses_blank = 0;
      renderScoreLine();
      openModal();
      renderQuestion();
    }

    function startQuizFalladas(){
      const d = buildDeckForFalladas();
      if(!d.length){
        alert("No tienes falladas guardadas aún.");
        return;
      }
      currentMode = "falladas";
      currentId = "FALLADAS";
      deck = d;
      idx = 0;
      ses_ok = 0; ses_bad = 0; ses_blank = 0;
      renderScoreLine();
      openModal();
      renderQuestion();
    }

    function blankQuestion(){
      if(answered) return;
      answered = true;
      ses_blank += 1;
      setFeedback("bad", "En blanco ⚪", currentQ ? currentQ.explicacion : "");
      renderScoreLine();
      refreshTemaStats();
    }

    function refreshTemaStats(){
      const total = TEMA_POOL.length;
      const wrongCount = Object.keys(STORE.wrongUids || {}).length;
      if(badgeTemaTotal){
        badgeTemaTotal.textContent = `${total} cargadas · ${wrongCount} falladas guardadas`;
      }
      if(diag){
        diag.innerHTML = `Diagnóstico: <b>OK</b> · Epígrafes detectados: <b>${extraerEncabezados().length}</b> · Preguntas cargadas: <b>${TEMA_POOL.length}</b>`;
      }
    }

    /* =========================
       ✅ RENDER ACORDEÓN EN CASCADA (ÁRBOL)
    ========================= */
    const cont = document.getElementById("contenido");
    cont.innerHTML = "";

    const heads = extraerEncabezados();

    // Construye nodos
    const nodesById = new Map();
    heads.forEach(h=>{
      nodesById.set(h.id, { ...h, children: [] });
    });

    // Enlaza padre-hijo
    const roots = [];
    heads.forEach(h=>{
      const node = nodesById.get(h.id);
      const pid = parentId(h.id);
      if(pid && nodesById.has(pid)){
        nodesById.get(pid).children.push(node);
      }else{
        roots.push(node);
      }
    });

    // Ordena hijos numéricamente (1.10 después de 1.2, etc.)
    function cmpIds(a,b){
      const pa = a.id.split(".").map(Number);
      const pb = b.id.split(".").map(Number);
      const len = Math.max(pa.length, pb.length);
      for(let i=0;i<len;i++){
        const xa = pa[i] ?? -1;
        const xb = pb[i] ?? -1;
        if(xa !== xb) return xa - xb;
      }
      return 0;
    }
    function sortTree(list){
      list.sort(cmpIds);
      list.forEach(n=>sortTree(n.children));
    }
    sortTree(roots);

    // Render recursivo
function renderNode(node){
  let txt = textoPorId(node.id);
  const idea = (IDEAS_CLAVE[node.id] ?? "").toString().trim();
  const quizCount = Array.isArray(QUIZ[node.id]) ? QUIZ[node.id].length : 0;

  const titleNoId = node.titulo.replace(
    new RegExp("^" + node.id.replace(/\./g,"\\.") + "\\.\\s*"),
    ""
  );

  // ✅ QUITA el título repetido al inicio del texto
  txt = quitarTituloRepetidoSeguro(txt, titleNoId);

  const d = document.createElement("details");
  d.open = false;
  d.dataset.id = node.id;

      d.innerHTML = `
        <summary>
          <div class="sumLeft">
            <span class="pill">${escapeHtml(node.id)}</span>
            <span class="sumTitle">${escapeHtml(titleNoId)}</span>
          </div>
          <div class="sumRight" style="display:flex; gap:10px; align-items:center;">
            ${quizCount ? `<span class="badge"></span>` : `<span class="badge"></span>`}
          </div>
        </summary>

        <div class="inner">
          ${txt ? `<div class="prio"><div class="tag">Texto prioritario</div>${formatearParrafos(txt)}</div>` : ""}
          ${idea ? `<div class="idea"><div class="tag">Idea clave</div>${escapeHtml(idea)}</div>` : ""}

          <div class="rowActions">
            ${quizCount ? `<button class="btn btnPrimary" type="button" data-quiz="${escapeHtml(node.id)}">Pregúntame</button>` : ""}
            <span class="badge">Epígrafe ${escapeHtml(node.id)}</span>
          </div>

          ${quizCount ? `
            <div class="quizBox">
              <div class="tag">Banco (cargado)</div>
              <div style="opacity:.85; font-size:13px">
                Tienes ${quizCount} preguntas en este epígrafe.
              </div>
            </div>
          ` : ""}

          <div class="children" style="margin-top:10px; padding-left:14px; border-left:2px solid rgba(17,24,39,.08)"></div>
        </div>
      `;

      // ✅ Cierre inteligente: deja abierto ancestros + descendientes; cierra lo demás
      d.addEventListener("toggle", () => {
        if(!d.open) return;

        const idActual = d.dataset.id;

        cont.querySelectorAll("details").forEach(other=>{
          if(other === d) return;
          const otherId = other.dataset.id;
          if(!otherId) return;

          const esDescDeActual = esDescendiente(otherId, idActual);
          const esAncestroDeActual = esDescendiente(idActual, otherId);

          if(!esDescDeActual && !esAncestroDeActual){
            other.open = false;
          }
        });
      });

      // Render hijos dentro del padre (cascada real)
      const childrenBox = d.querySelector(".children");
      node.children.forEach(ch=>{
        childrenBox.appendChild(renderNode(ch));
      });

      return d;
    }

    if(!heads.length){
      cont.innerHTML = `
        <div class="prio">
          <div class="tag">No se detectaron epígrafes</div>
          <div style="opacity:.85">
            El detector busca líneas tipo <b>“1. TÍTULO”</b> o <b>“1.1. TÍTULO”</b> (con punto y espacio).<br><br>
            Primeros 300 caracteres del texto:<br><br>
            <code style="white-space:pre-wrap">${escapeHtml(PDF_TEXTO.slice(0,300))}</code>
          </div>
        </div>
      `;
    }else{
      roots.forEach(r=>cont.appendChild(renderNode(r)));
    }

    // Click de botones “Pregúntame”
    cont.addEventListener("click", (e)=>{
      const btn = e.target.closest("button[data-quiz]");
      if(!btn) return;
      const id = btn.getAttribute("data-quiz");
      if(!id) return;
      startQuizForId(id);
    });

    /* =========================
       EVENTOS UI
    ========================= */
    btnCloseModal.addEventListener("click", closeModal);
    modalOverlay.addEventListener("click", (e)=>{
      if(e.target === modalOverlay) closeModal();
    });
    btnNextQuestion.addEventListener("click", renderQuestion);
    btnBlank.addEventListener("click", blankQuestion);

    document.addEventListener("keydown", (e)=>{
      if(!modalOverlay.classList.contains("show")) return;
      if(e.key === "Escape") closeModal();
      if(e.key === "Enter") renderQuestion();
    });

    btnTemaRandom.addEventListener("click", startQuizTema);
    btnSoloFalladas.addEventListener("click", startQuizFalladas);

    btnResetStats.addEventListener("click", ()=>{
      if(!confirm("¿Seguro que quieres borrar falladas y stats guardadas?")) return;
      STORE = { wrongUids: {}, stats: { ok:0, bad:0, blank:0 } };
      saveStore();
      refreshTemaStats();
      alert("Listo: reiniciado.");
    });

    // ✅ Arranque
    refreshTemaStats();
    renderScoreLine();

  } catch (err) {
    showErr("Error fatal: " + (err && err.message ? err.message : String(err)));
    if(diag){
      diag.innerHTML = `Diagnóstico: <b>ERROR</b>`;
    }
  }
});
</script>
</body>
</html>